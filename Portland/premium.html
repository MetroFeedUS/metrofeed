<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MetroFeed Trip Planner</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #0d0d0d;
      color: #cccccc;
      height: 100%;
    }
    #map {
      width: 100vw;
      height: 100vh;
    }
    .leaflet-popup-content {
      font-size: 0.85rem;
      color: #000;
    }
    #infoBox, #resetBtn {
      display: none;
    }
    #plannerToggle {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #1e88e5;
      border: none;
      color: white;
      padding: 8px 12px;
      font-size: 0.9rem;
      border-radius: 8px;
      z-index: 1000;
      cursor: pointer;
    }
    #searchBar {
      display: none;
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1000;
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #searchBar select {
      background: #222;
      color: white;
      border: none;
      padding: 6px 10px;
      font-size: 0.9rem;
      border-radius: 5px;
    }
    #infoBox {
      position: absolute;
      top: 60px;
      left: 12px;
      background: rgba(0,0,0,0.7);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 0.9rem;
      z-index: 1000;
    }
    #resetBtn {
      margin-top: 6px;
      background: #444;
      border: none;
      color: white;
      padding: 4px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    #toast {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1e88e5;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9rem;
      display: none;
      z-index: 9999;
      max-width: 90vw;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="plannerToggle">Trip Planner</button>
  <div id="searchBar">
    <label for="originSelect">
      <img src="https://upload.wikimedia.org/wikipedia/commons/6/6e/Green_flag_icon.svg" alt="Origin" style="height: 14px; vertical-align: middle; margin-right: 5px;">
    </label>
    <select id="originSelect"></select>

    <label for="routeSelect">
      <img src="https://upload.wikimedia.org/wikipedia/commons/7/74/Map_symbol_route.svg" alt="Route" style="height: 14px; vertical-align: middle; margin-left: 10px; margin-right: 5px;">
    </label>
    <select id="routeSelect"></select>
  </div>

  <div id="infoBox">
    <div><b>Click the map to:</b></div>
    <div>1. Select origin <img src="https://upload.wikimedia.org/wikipedia/commons/6/6e/Green_flag_icon.svg" alt="Green Flag" style="height: 14px; vertical-align: middle;"> </div>
    <div>2. Select destination <img src="https://upload.wikimedia.org/wikipedia/commons/5/59/Checkered-flag.svg" alt="Checkered Flag" style="height: 14px; vertical-align: middle;"> </div>
    <button id="resetBtn">Reset</button>
  </div>
  <div id="toast"></div>

  <script src="mastermap.js"></script>
  <script>
    const map = L.map('map').setView([45.515, -122.678], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);

    const greenFlagIcon = L.icon({
      iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/6/6e/Green_flag_icon.svg',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
    });

    const checkeredFlagIcon = L.icon({
      iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/5/59/Checkered-flag.svg',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
    });

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180, φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function showClosestRouteToUser() {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 14);

        let bestRoute = null;
        let minDist = Infinity;

        masterRoutes.forEach(route => {
          route.stops.forEach(stop => {
            const d = getDistance(latitude, longitude, stop.lat, stop.lon);
            if (d < minDist) {
              minDist = d;
              bestRoute = route;
            }
          });
        });

        if (bestRoute) {
          const shape = L.polyline(bestRoute.shape, {
            color: 'blue', weight: 4, opacity: 0.8
          }).addTo(map);
          shape.bindPopup(bestRoute.route_title);

          bestRoute.stops.forEach(stop => {
            L.circleMarker([stop.lat, stop.lon], {
              radius: 4, color: 'red', fillColor: 'red', fillOpacity: 0.8
            }).addTo(map).bindPopup(`<b>${stop.name}</b>`);
          });
        }
      }, err => {
        console.error("Location error:", err);
      });
    }

    function placeStopMarker(stop, isOrigin) {
      const icon = isOrigin ? greenFlagIcon : checkeredFlagIcon;
      return L.marker([stop.lat, stop.lon], { icon }).addTo(map);
    }

    showClosestRouteToUser();

    const allStops = {};
    masterRoutes.forEach(route => {
      route.stops.forEach(stop => {
        if (!allStops[stop.stop_id]) allStops[stop.stop_id] = stop;
      });
    });

    const originSelect = document.getElementById('originSelect');
    for (const stopId in allStops) {
      const stop = allStops[stopId];
      const option = document.createElement('option');
      option.value = stopId;
      option.textContent = stop.name;
      originSelect.appendChild(option);
    }

    const routeSelect = document.getElementById('routeSelect');
    masterRoutes.forEach(route => {
      const option = document.createElement('option');
      option.value = `${route.route_number}_${route.direction_id}`;
      option.textContent = `${route.route_title} (Dir ${route.direction_id})`;
      routeSelect.appendChild(option);
    });

    routeSelect.addEventListener('change', (e) => {
      const val = e.target.value;
      const [num, dir] = val.split('_');
      const route = masterRoutes.find(r => r.route_number == num && r.direction_id == Number(dir));
      if (route) {
        if (window.routeLayer) map.removeLayer(window.routeLayer);
        const shape = L.polyline(route.shape, { color: 'orange', weight: 4 }).addTo(map);
        window.routeLayer = shape;
        shape.bindPopup(route.route_title).openPopup();
        map.fitBounds(shape.getBounds());
      }
    });

    document.getElementById('plannerToggle').addEventListener('click', () => {
      const bar = document.getElementById('searchBar');
      bar.style.display = bar.style.display === 'none' ? 'flex' : 'none';
    });
  </script>
</body>
</html>
