<!DOCTYPE html>
<html lang="en" class="founder"> <!-- Change to gold, silver, bronze -->

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MetroFeed Premium Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* (CSS styles remain unchanged) */
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Load Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Load masterRoutes data -->
  <script src="mastermap.js"></script>

  <script>
    // ==== Data Indexing for Search Bar ==== 
    const routeIndex = new Map();
    const stopIndex = new Map();
    masterRoutes.forEach(route => {
      const key = route.route_title.toLowerCase();
      routeIndex.set(key, route);
      route.stops.forEach(stop => {
        const name = stop.name.toLowerCase();
        if (!stopIndex.has(name)) stopIndex.set(name, []);
        stopIndex.get(name).push({ route, stop });
      });
    });

    // ==== Helper Functions ==== 
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180, φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2 - lat1) * Math.PI/180;
      const Δλ = (lon2 - lon1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function showClosestRouteToUser() {
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        let closest = null;
        let minDist = Infinity;
        masterRoutes.forEach(route => {
          route.stops.forEach(stop => {
            const dist = getDistance(latitude, longitude, stop.lat, stop.lon);
            if (dist < minDist) {
              minDist = dist;
              closest = route;
            }
          });
        });
        if (closest) drawRoute(closest);
      });
    }

    let routeLayer;
    function drawRoute(route) {
      if (routeLayer) map.removeLayer(routeLayer);
      routeLayer = L.polyline(route.shape, { color: 'deepskyblue', weight: 4 }).addTo(map);
      map.fitBounds(routeLayer.getBounds());
    }

    const map = L.map('map').setView([45.5122, -122.6587], 13);
    const maptilerKey = "9c1G1fH44ajCv0W1HJMt";
    const dayTiles = L.tileLayer(`https://api.maptiler.com/maps/019734c4-68a3-70e5-8c72-011b52a8fd07/256/{z}/{x}/{y}.png?key=${maptilerKey}`, {
      attribution: '&copy; <a href="https://www.maptiler.com/">MapTiler</a>'
    });
    const nightTiles = L.tileLayer(`https://api.maptiler.com/maps/019748d2-04be-7c08-b477-fe99e8e81a0a/256/{z}/{x}/{y}.png?key=${maptilerKey}`, {
      attribution: '&copy; <a href="https://www.maptiler.com/">MapTiler</a>'
    });

    dayTiles.addTo(map);

    let darkModeOn = false;
    const modeToggle = document.getElementById('modeToggle');
    modeToggle.addEventListener('click', () => {
      darkModeOn = !darkModeOn;
      if (darkModeOn) {
        map.removeLayer(dayTiles);
        map.addLayer(nightTiles);
        modeToggle.classList.add("active");
      } else {
        map.removeLayer(nightTiles);
        map.addLayer(dayTiles);
        modeToggle.classList.remove("active");
      }
    });

    const toggle = document.getElementById('menuToggle');
    const menu = document.getElementById('iconMenu');
    const moreBtn = document.getElementById('moreBtn');
    const settingsBar = document.getElementById('settingsBar');
    const buttons = document.querySelectorAll('.icon-button');

    toggle.addEventListener('click', () => {
      const isOpen = menu.style.display === 'flex';
      menu.style.display = isOpen ? 'none' : 'flex';
      settingsBar.classList.remove("active");
    });

    moreBtn.addEventListener('click', () => {
      settingsBar.classList.toggle("active");
    });

    buttons.forEach(btn => {
      if (btn !== moreBtn) {
        btn.addEventListener('click', () => {
          btn.classList.toggle('active');
        });
      }
    });

    showClosestRouteToUser();
  </script>
</body>
</html>
