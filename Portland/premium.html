<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MetroFeed Trip Planner</title>

  <!-- Leaflet Styles -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Tom Select Styles -->
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet" />

  <!-- Leaflet Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Tom Select Script -->
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #0d0d0d;
      color: #cccccc;
      height: 100%;
    }

    #map {
      width: 100vw;
      height: 100vh;
    }

    .leaflet-popup-content {
      font-size: 0.85rem;
      color: #000;
    }

    #plannerToggle {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #1e88e5;
      border: none;
      color: white;
      padding: 8px 12px;
      font-size: 0.9rem;
      border-radius: 8px;
      z-index: 1000;
      cursor: pointer;
    }

    #searchBar {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(0,0,0,0.85);
      padding: 10px;
      border-radius: 8px;
      z-index: 1000;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    #searchBar select {
      padding: 6px;
      background: #222;
      color: white;
      border: 1px solid #555;
      border-radius: 5px;
      min-width: 140px;
      max-width: 200px;
      font-size: 0.9rem;
    }

    #infoBox {
      position: absolute;
      top: 60px;
      left: 12px;
      background: rgba(0,0,0,0.7);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 0.9rem;
      z-index: 1000;
    }

    #resetBtn {
      margin-top: 6px;
      background: #444;
      border: none;
      color: white;
      padding: 4px 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    #toast {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1e88e5;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9rem;
      display: none;
      z-index: 9999;
      max-width: 90vw;
      text-align: center;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="searchBar">
  <select id="originDropdown"></select>
  <select id="destinationDropdown"></select>
  <select id="routeDropdown"></select>
</div>
  <button id="plannerToggle">Trip Planner</button>
  <div id="infoBox">
    <div><b>Click the map to:</b></div>
    <div>1. Select origin (blue)</div>
    <div>2. Select destination (green)</div>
    <button id="resetBtn">Reset</button>
  </div>
  <div id="toast"></div>

  <script src="mastermap.js"></script>
 <script>
  const map = L.map('map', {
    maxBounds: [
      [45.40, -122.85],  // Southwest corner of Portland
      [45.65, -122.45]   // Northeast corner of Portland
    ],
    maxBoundsViscosity: 1.0,
    minZoom: 11,
    maxZoom: 17
  }).setView([45.515, -122.678], 12);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
    maxZoom: 19
  }).addTo(map);

  let tripPlannerMode = false;
  let originMarker = null;
  let destinationMarker = null;
  let originStop = null;
  let destinationStop = null;
  let clickCount = 0;
  let routeShapes = [];
  let busMarkers = [];


    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180, φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
function decodeHtmlEntities(str) {
  const txt = document.createElement("textarea");
  txt.innerHTML = str;
  return txt.value;
}

// Populate dropdowns
const originDropdown = document.getElementById("originDropdown");
const destinationDropdown = document.getElementById("destinationDropdown");
const routeDropdown = document.getElementById("routeDropdown");

const stopMap = new Map();
const addedStops = new Set();
const addedRoutes = new Set();

masterRoutes.forEach(route => {
  if (!addedRoutes.has(route.route_id)) {
    let opt = document.createElement("option");
    opt.value = route.route_id;
    opt.innerHTML = decodeHtmlEntities(decodeHtmlEntities(route.route_title));
    routeDropdown.appendChild(opt);
    addedRoutes.add(route.route_id);
  }
  route.stops.forEach(stop => {
    if (!addedStops.has(stop.stop_id)) {
      let opt1 = document.createElement("option");
      opt1.value = stop.stop_id;
      opt1.innerHTML = decodeHtmlEntities(decodeHtmlEntities(stop.name));
      let opt2 = opt1.cloneNode(true);
      originDropdown.appendChild(opt1);
      destinationDropdown.appendChild(opt2);
      stopMap.set(stop.stop_id, stop);
      addedStops.add(stop.stop_id);
    }
  });
});

function selectStopById(stopId, isOrigin) {
  const stop = stopMap.get(stopId);
  if (stop) {
    selectStop(stop);
    map.setView([stop.lat, stop.lon], 15);
  }
}

originDropdown.addEventListener("change", e => {
  if (!tripPlannerMode) enableTripPlannerMode();
  selectStopById(e.target.value, true);
});

destinationDropdown.addEventListener("change", e => {
  if (!tripPlannerMode) enableTripPlannerMode();
  selectStopById(e.target.value, false);
});

routeDropdown.addEventListener("change", e => {
  const route = masterRoutes.find(r => r.route_id == e.target.value);
  if (route) {
    drawRouteShape(route);
    fetchLiveBus(route.route_id);
  }
});


    function findStopsNear(lat, lon, radiusMeters = 40) {
      let nearby = [];
      masterRoutes.forEach(route => {
        route.stops.forEach(stop => {
          const d = getDistance(lat, lon, stop.lat, stop.lon);
          if (d <= radiusMeters) nearby.push(stop);
        });
      });
      return nearby;
    }

    function showToast(msg, buttons = []) {
      const toast = document.getElementById("toast");
      toast.innerHTML = msg;
      buttons.forEach(({ label, onClick }) => {
        const btn = document.createElement('button');
        btn.textContent = label;
        btn.style.marginLeft = '10px';
        btn.style.background = '#fff';
        btn.style.color = '#000';
        btn.style.border = 'none';
        btn.style.padding = '4px 8px';
        btn.style.borderRadius = '5px';
        btn.onclick = () => {
          toast.style.display = 'none';
          onClick();
        };
        toast.appendChild(btn);
      });
      toast.style.display = "block";
    }

    function findRouteByStop(stop) {
      return masterRoutes.find(route => route.stops.some(s => s.stop_id === stop.stop_id));
    }

    function drawRouteShape(route) {
      const shape = L.polyline(route.shape, {
        color: 'red', weight: 4, opacity: 0.8
      }).addTo(map);
      shape.bindPopup(decodeHtmlEntities(route.route_title));
      routeShapes.push(shape);
    }

    function fetchLiveBus(routeId) {
      fetch(`https://developer.trimet.org/ws/v2/vehicles?routes=${routeId}&appID=YOUR_APP_ID`)
        .then(res => res.json())
        .then(data => {
          data.resultSet.vehicle.forEach(bus => {
            const marker = L.circleMarker([bus.latitude, bus.longitude], {
              radius: 6,
              fillColor: 'lime',
              fillOpacity: 1,
              color: '#0f0',
              weight: 1
            }).addTo(map).bindPopup(`Bus ID: ${bus.vehicleID}`);
            busMarkers.push(marker);
          });
        })
        .catch(err => console.error("Live bus error:", err));
    }

    function showRouteAndLiveBus(stop) {
      const route = findRouteByStop(stop);
      if (route) {
        drawRouteShape(route);
        fetchLiveBus(route.route_id);
      }
    }

    function resetMarkers() {
      if (originMarker) map.removeLayer(originMarker);
      if (destinationMarker) map.removeLayer(destinationMarker);
      originMarker = destinationMarker = null;
      originStop = destinationStop = null;
      clickCount = 0;
      routeShapes.forEach(s => map.removeLayer(s));
      busMarkers.forEach(b => map.removeLayer(b));
      routeShapes = [];
      busMarkers = [];
      showToast("Markers reset.");
    }

    function placeStopMarker(stop, isOrigin) {
      const marker = L.marker([stop.lat, stop.lon], {
        icon: L.divIcon({
          className: '',
          html: `<div style="background:${isOrigin ? '#2196f3' : '#4caf50'};color:white;padding:6px 10px;border-radius:8px;">${isOrigin ? 'Start' : 'End'}</div>`,
          iconAnchor: [20, 20]
        })
      }).addTo(map);
      return marker;
    }

    function selectStop(stop) {
      if (clickCount === 0) {
        if (originMarker) map.removeLayer(originMarker);
        originMarker = placeStopMarker(stop, true);
        originStop = stop;
        showRouteAndLiveBus(stop);
        clickCount++;
        showToast("Origin set. Now select a destination.");
      } else if (clickCount === 1) {
        if (destinationMarker) map.removeLayer(destinationMarker);
        destinationMarker = placeStopMarker(stop, false);
        destinationStop = stop;
        showRouteAndLiveBus(stop);
        clickCount++;
        showToast("Destination set. Both routes displayed.");
      } else {
        showToast("Both points already set. Use Reset to try again.");
      }
    }

    document.getElementById("plannerToggle").addEventListener("click", () => {
      if (!tripPlannerMode) {
        tripPlannerMode = true;
        document.getElementById('infoBox').style.display = 'block';
        document.getElementById('resetBtn').style.display = 'block';
        showToast("Trip planner mode enabled. Click the map to begin.");
      } else {
        tripPlannerMode = false;
        document.getElementById('infoBox').style.display = 'none';
        document.getElementById('resetBtn').style.display = 'none';
        resetMarkers();
        showToast("Trip planner closed.");
      }
    });

    document.getElementById("resetBtn").addEventListener("click", resetMarkers);

    map.on('click', function (e) {
      if (!tripPlannerMode) return;
      const { lat, lng } = e.latlng;
      const nearbyStops = findStopsNear(lat, lng);

      if (nearbyStops.length === 0) {
        showToast("No stops nearby. Try closer to a stop.");
        return;
      }

      if (nearbyStops.length === 1) {
        selectStop(nearbyStops[0]);
      } else {
        showToast("Multiple stops found. Pick one:",
          nearbyStops.slice(0, 3).map(stop => ({
            label: stop.name,
            onClick: () => selectStop(stop)
          }))
        );
      }
    });

    function showClosestRouteToUser() {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 14);

        let bestRoute = null;
        let minDist = Infinity;

        masterRoutes.forEach(route => {
          route.stops.forEach(stop => {
            const d = getDistance(latitude, longitude, stop.lat, stop.lon);
            if (d < minDist) {
              minDist = d;
              bestRoute = route;
            }
          });
        });

        if (bestRoute) {
          const shape = L.polyline(bestRoute.shape, {
            color: 'blue', weight: 4, opacity: 0.8
          }).addTo(map);
          shape.bindPopup(bestRoute.route_title);

          bestRoute.stops.forEach(stop => {
            L.circleMarker([stop.lat, stop.lon], {
              radius: 4, color: 'red', fillColor: 'red', fillOpacity: 0.8
            }).addTo(map).bindPopup(`<b>${stop.name}</b>`);
          });
        }
      }, err => {
        console.error("Location error:", err);
        showToast("Location access denied.");
      });
    }

    showClosestRouteToUser();

new TomSelect("#originDropdown", {
  maxOptions: 30,
  maxItems: 1,
  placeholder: "Select origin stop...",
  onFocus: function() {
    this.clear(); // Clears the selected value
    this.setTextboxValue(''); // Clears the text input
    this.refreshOptions();    // Refresh the dropdown list
  }
});

new TomSelect("#destinationDropdown", {
  maxOptions: 30,
  maxItems: 1,
  placeholder: "Select destination stop...",
  onFocus: function() {
    this.clear();
    this.setTextboxValue('');
    this.refreshOptions();
  }
});

new TomSelect("#routeDropdown", {
  maxOptions: 30,
  maxItems: 1,
  placeholder: "Select route...",
  onFocus: function() {
    this.clear();
    this.setTextboxValue('');
    this.refreshOptions();
  }
});

  </script>
</body>
</html>
