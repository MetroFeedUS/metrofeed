<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ================================
       SECTION: Meta & Title
       ================================ -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MetroFeed Trip Planner</title>

  <!-- ================================
       SECTION: External CSS Libraries
       ================================ -->

  <!-- Leaflet CSS for map tiles and controls -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Tom Select CSS for searchable dropdowns -->
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet" />

  <!-- ================================
       SECTION: External JS Libraries (head)
       ================================ -->

  <!-- Leaflet JS for interactive mapping -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Tom Select JS for searchable dropdowns -->
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

  <!-- ================================
       SECTION: Inline Styles
       ================================ -->
  <style>
    /* ----------------------------
       Layout & Base Styles
       ---------------------------- */
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #0d0d0d;
      color: #cccccc;
      height: 100%;
    }

    /* Map container fills viewport */
    #map {
      width: 100vw;
      height: 100vh;
    }

    /* Popup styling overrides (font size, color) */
    .leaflet-popup-content {
      font-size: 0.85rem;
      color: #000;
    }

    /* ----------------------------
       Search Bar Container
       ---------------------------- */
    #searchBar {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      padding: 12px 16px;
      border-radius: 10px;
      z-index: 1000;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
      max-width: 95vw;
    }

    /* ----------------------------
       Trip Planner Toggle Button
       ---------------------------- */
    #plannerToggle {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #1e88e5;
      border: none;
      color: white;
      padding: 8px 12px;
      font-size: 0.9rem;
      border-radius: 8px;
      z-index: 1000;
      cursor: pointer;
    }

    /* ----------------------------
       Info Box (instructions)
       ---------------------------- */
    #infoBox {
      position: absolute;
      top: 60px;
      left: 12px;
      background: rgba(0,0,0,0.7);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 0.9rem;
      z-index: 1000;
    }

    /* Reset Button Styles */
    #resetBtn {
      margin-top: 6px;
      background: #444;
      border: none;
      color: white;
      padding: 4px 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    /* ----------------------------
       Toast Notification (bottom center)
       ---------------------------- */
    #toast {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1e88e5;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9rem;
      display: none;
      z-index: 9999;
      max-width: 90vw;
      text-align: center;
    }

    /* ----------------------------
       Input Group (search fields + flags)
       ---------------------------- */
    .input-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Flag icon base styles */
    .flag-icon {
      width: 18px;
      height: 18px;
      border-radius: 3px;
    }

    /* Green flag for origin */
    .green-flag {
      background-color: limegreen;
    }

    /* Checkered flag for destination */
    .checkered-flag {
      background-image: linear-gradient(
        45deg,
        black 25%,
        white 25%,
        white 50%,
        black 50%,
        black 75%,
        white 75%,
        white
      );
      background-size: 8px 8px;
    }

    /* ----------------------------
       Responsive Styles (max-width: 600px)
       ---------------------------- */
    @media (max-width: 600px) {
      #searchBar {
        flex-direction: column;
        align-items: stretch;
        padding: 4px 6px;
        gap: 4px;
      }

      #searchBar .input-group {
        flex-direction: row;
        align-items: center;
        gap: 6px;
        width: 100%;
      }

      #searchBar select {
        font-size: 0.75rem;
        padding: 4px 6px;
        flex: 1;
        max-width: 100%;
        width: 100%;
      }

      .flag-icon {
        width: 14px;
        height: 14px;
      }

      #plannerToggle {
        font-size: 0.75rem;
        padding: 6px 10px;
      }
    }
  </style>
</head>

<body>
  <!-- ================================
       SECTION: Map Container
       ================================ -->
  <div id="map"></div>

  <!-- ================================
       SECTION: Search Bar with Dropdowns
       ================================ -->
  <div id="searchBar">
    <div class="input-group">
      <!-- Origin Flag Icon -->
      <div class="flag-icon green-flag"></div>
      <!-- Origin Dropdown (populated via JS) -->
      <select id="originDropdown"></select>
    </div>
    <div class="input-group">
      <!-- Destination Flag Icon -->
      <div class="flag-icon checkered-flag"></div>
      <!-- Destination Dropdown (populated via JS) -->
      <select id="destinationDropdown"></select>
    </div>
    <!-- Route Dropdown (populated via JS) -->
    <select id="routeDropdown"></select>
  </div>

  <!-- ================================
       SECTION: Trip Planner Toggle Button
       ================================ -->
  <button id="plannerToggle">Trip Planner</button>

  <!-- ================================
       SECTION: Info Box (Instructions & Reset)
       ================================ -->
  <div id="infoBox">
    <div><b>Click the map to:</b></div>
    <div>1. Select origin (blue)</div>
    <div>2. Select destination (green)</div>
    <button id="resetBtn">Reset</button>
  </div>

  <!-- ================================
       SECTION: Toast Notification (hidden initially)
       ================================ -->
  <div id="toast"></div>

  <!-- ================================
       SECTION: Master Routes Data (external)
       ================================ -->
  <script src="mastermap.js"></script>

  <!-- ================================
       SECTION: Main JS Logic
       ================================ -->
  <script>
    /* ----------------------------
       Map Initialization
       ---------------------------- */
    const map = L.map('map', {
      maxBounds: [
        [45.40, -122.85],  // Southwest corner of Portland
        [45.65, -122.45]   // Northeast corner of Portland
      ],
      maxBoundsViscosity: 1.0,
      minZoom: 11,
      maxZoom: 17
    }).setView([45.515, -122.678], 12);

    // Base tile layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);

    /* ----------------------------
       Trip Planner State Variables
       ---------------------------- */
    let tripPlannerMode = false;
    let originMarker = null;
    let destinationMarker = null;
    let originStop = null;
    let destinationStop = null;
    let clickCount = 0;
    let routeShapes = [];  // Array to store drawn polylines for routes
    let busMarkers = [];   // Array to store live bus markers

    /* ----------------------------
       UTILITY FUNCTION: Distance Calculation
       ---------------------------- */
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Earth radius in meters
      const φ1 = lat1 * Math.PI/180, φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2 - lat1) * Math.PI/180;
      const Δλ = (lon2 - lon1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c; // Distance in meters
    }

    /* ----------------------------
       UTILITY FUNCTION: Decode HTML Entities
       ---------------------------- */
    function decodeHtmlEntities(str) {
      const txt = document.createElement("textarea");
      txt.innerHTML = str;
      return txt.value;
    }

    /* ----------------------------
       SECTION: Populate Dropdowns (Origin, Destination, Route)
       ---------------------------- */
    const originDropdown = document.getElementById("originDropdown");
    const destinationDropdown = document.getElementById("destinationDropdown");
    const routeDropdown = document.getElementById("routeDropdown");

    const stopMap = new Map();       // Map stop_id → stop object
    const addedStops = new Set();    // Track which stops have been added
    const addedRoutes = new Set();   // Track which routes have been added

    // Iterate through masterRoutes (from mastermap.js)
    masterRoutes.forEach(route => {
      // Add route to 'routeDropdown' only once
      if (!addedRoutes.has(route.route_id)) {
        let opt = document.createElement("option");
        opt.value = route.route_id;
        opt.innerHTML = decodeHtmlEntities(decodeHtmlEntities(route.route_title));
        routeDropdown.appendChild(opt);
        addedRoutes.add(route.route_id);
      }

      // Add each stop to both origin and destination dropdowns once
      route.stops.forEach(stop => {
        if (!addedStops.has(stop.stop_id)) {
          let opt1 = document.createElement("option");
          opt1.value = stop.stop_id;
          opt1.innerHTML = decodeHtmlEntities(decodeHtmlEntities(stop.name));
          let opt2 = opt1.cloneNode(true);

          originDropdown.appendChild(opt1);
          destinationDropdown.appendChild(opt2);

          // Store stop object in stopMap for lookup by ID
          stopMap.set(stop.stop_id, stop);
          addedStops.add(stop.stop_id);
        }
      });
    });

    /* ----------------------------
       FUNCTION: Select Stop by ID (via dropdown)
       ---------------------------- */
    function selectStopById(stopId, isOrigin) {
      const stop = stopMap.get(stopId);
      if (stop) {
        selectStop(stop);
        map.setView([stop.lat, stop.lon], 15);
      }
    }

    // When origin dropdown changes, enable trip planner mode if needed
    originDropdown.addEventListener("change", e => {
      if (!tripPlannerMode) enableTripPlannerMode();
      selectStopById(e.target.value, true);
    });

    // When destination dropdown changes, enable trip planner mode if needed
    destinationDropdown.addEventListener("change", e => {
      if (!tripPlannerMode) enableTripPlannerMode();
      selectStopById(e.target.value, false);
    });

    // When route dropdown changes, draw selected route and fetch live bus data
    routeDropdown.addEventListener("change", e => {
      const route = masterRoutes.find(r => r.route_id == e.target.value);
      if (route) {
        drawRouteShape(route);
        fetchLiveBus(route.route_id);
      }
    });

    /* ----------------------------
       FUNCTION: Find Nearby Stops (within radius)
       ---------------------------- */
    function findStopsNear(lat, lon, radiusMeters = 40) {
      let nearby = [];
      masterRoutes.forEach(route => {
        route.stops.forEach(stop => {
          const d = getDistance(lat, lon, stop.lat, stop.lon);
          if (d <= radiusMeters) nearby.push(stop);
        });
      });
      return nearby;
    }

    /* ----------------------------
       FUNCTION: Show Toast Notification
       ---------------------------- */
    function showToast(msg, buttons = []) {
      const toast = document.getElementById("toast");
      toast.innerHTML = msg;
      buttons.forEach(({ label, onClick }) => {
        const btn = document.createElement('button');
        btn.textContent = label;
        btn.style.marginLeft = '10px';
        btn.style.background = '#fff';
        btn.style.color = '#000';
        btn.style.border = 'none';
        btn.style.padding = '4px 8px';
        btn.style.borderRadius = '5px';
        btn.onclick = () => {
          toast.style.display = 'none';
          onClick();
        };
        toast.appendChild(btn);
      });
      toast.style.display = "block";
    }

    /* ----------------------------
       FUNCTION: Find Route Object by Stop
       ---------------------------- */
    function findRouteByStop(stop) {
      return masterRoutes.find(route => route.stops.some(s => s.stop_id === stop.stop_id));
    }

    /* ----------------------------
       FUNCTION: Draw Route Shape on Map
       ---------------------------- */
    function drawRouteShape(route) {
      const shape = L.polyline(route.shape, {
        color: 'red',
        weight: 4,
        opacity: 0.8
      }).addTo(map);
      shape.bindPopup(decodeHtmlEntities(route.route_title));
      routeShapes.push(shape);
    }

    /* ----------------------------
       FUNCTION: Fetch Live Bus Locations for a Route
       ---------------------------- */
    function fetchLiveBus(routeId) {
      // NOTE: Replace YOUR_APP_ID with a valid Trimet appID
      fetch(`https://developer.trimet.org/ws/v2/vehicles?routes=${routeId}&appID=YOUR_APP_ID`)
        .then(res => res.json())
        .then(data => {
          data.resultSet.vehicle.forEach(bus => {
            const marker = L.circleMarker([bus.latitude, bus.longitude], {
              radius: 6,
              fillColor: 'lime',
              fillOpacity: 1,
              color: '#0f0',
              weight: 1
            }).addTo(map).bindPopup(`Bus ID: ${bus.vehicleID}`);
            busMarkers.push(marker);
          });
        })
        .catch(err => console.error("Live bus error:", err));
    }

    /* ----------------------------
       FUNCTION: Show Route & Live Bus for a Given Stop
       ---------------------------- */
    function showRouteAndLiveBus(stop) {
      const route = findRouteByStop(stop);
      if (route) {
        drawRouteShape(route);
        fetchLiveBus(route.route_id);
      }
    }

    /* ----------------------------
       FUNCTION: Reset All Markers & Overlays
       ---------------------------- */
    function resetMarkers() {
      if (originMarker) map.removeLayer(originMarker);
      if (destinationMarker) map.removeLayer(destinationMarker);
      originMarker = destinationMarker = null;
      originStop = destinationStop = null;
      clickCount = 0;

      // Remove all drawn route shapes from map
      routeShapes.forEach(s => map.removeLayer(s));
      routeShapes = [];

      // Remove all live bus markers from map
      busMarkers.forEach(b => map.removeLayer(b));
      busMarkers = [];

      showToast("Markers reset.");
    }

    /* ----------------------------
       FUNCTION: Place a Stop Marker (origin/ destination)
       ---------------------------- */
    function placeStopMarker(stop, isOrigin) {
      const marker = L.marker([stop.lat, stop.lon], {
        icon: L.divIcon({
          className: '',
          html: `<div style="background:${isOrigin ? '#2196f3' : '#4caf50'};color:white;padding:6px 10px;border-radius:8px;">${isOrigin ? 'Start' : 'End'}</div>`,
          iconAnchor: [20, 20]
        })
      }).addTo(map);
      return marker;
    }

    /* ----------------------------
       FUNCTION: Select a Stop via Click or Dropdown
       ---------------------------- */
    function selectStop(stop) {
      if (clickCount === 0) {
        // First click → set origin
        if (originMarker) map.removeLayer(originMarker);
        originMarker = placeStopMarker(stop, true);
        originStop = stop;
        showRouteAndLiveBus(stop);
        clickCount++;
        showToast("Origin set. Now select a destination.");
      } else if (clickCount === 1) {
        // Second click → set destination
        if (destinationMarker) map.removeLayer(destinationMarker);
        destinationMarker = placeStopMarker(stop, false);
        destinationStop = stop;
        showRouteAndLiveBus(stop);
        clickCount++;
        showToast("Destination set. Both routes displayed.");
      } else {
        // Already selected both stops
        showToast("Both points already set. Use Reset to try again.");
      }
    }

    /* ----------------------------
       FUNCTION: Enable Trip Planner Mode
       ---------------------------- */
    function enableTripPlannerMode() {
      tripPlannerMode = true;
      document.getElementById('infoBox').style.display = 'block';
      document.getElementById('resetBtn').style.display = 'block';
      showToast("Trip planner mode enabled. Click the map to begin.");
    }

    /* ----------------------------
       EVENT: Toggle Button Click (Open/Close Planner)
       ---------------------------- */
    document.getElementById("plannerToggle").addEventListener("click", () => {
      if (!tripPlannerMode) {
        enableTripPlannerMode();
      } else {
        tripPlannerMode = false;
        document.getElementById('infoBox').style.display = 'none';
        document.getElementById('resetBtn').style.display = 'none';
        resetMarkers();
        showToast("Trip planner closed.");
      }
    });

    /* ----------------------------
       EVENT: Reset Button Click
       ---------------------------- */
    document.getElementById("resetBtn").addEventListener("click", resetMarkers);

    /* ----------------------------
       EVENT: Map Click (Select Stops)
       ---------------------------- */
    map.on('click', function (e) {
      if (!tripPlannerMode) return;
      const { lat, lng } = e.latlng;
      const nearbyStops = findStopsNear(lat, lng);

      if (nearbyStops.length === 0) {
        showToast("No stops nearby. Try closer to a stop.");
        return;
      }

      if (nearbyStops.length === 1) {
        // Only one stop within radius → select it
        selectStop(nearbyStops[0]);
      } else {
        // Multiple stops found → show choices
        showToast("Multiple stops found. Pick one:",
          nearbyStops.slice(0, 3).map(stop => ({
            label: stop.name,
            onClick: () => selectStop(stop)
          }))
        );
      }
    });

    /* ----------------------------
       FUNCTION: Show Closest Route to User's Geolocation
       ---------------------------- */
    function showClosestRouteToUser() {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 14);

        let bestRoute = null;
        let minDist = Infinity;

        // Find route with stop nearest to user
        masterRoutes.forEach(route => {
          route.stops.forEach(stop => {
            const d = getDistance(latitude, longitude, stop.lat, stop.lon);
            if (d < minDist) {
              minDist = d;
              bestRoute = route;
            }
          });
        });

        if (bestRoute) {
          // Draw the closest route shape in blue
          const shape = L.polyline(bestRoute.shape, {
            color: 'blue',
            weight: 4,
            opacity: 0.8
          }).addTo(map);
          shape.bindPopup(bestRoute.route_title);

          // Draw all stops along that route as red markers
          bestRoute.stops.forEach(stop => {
            L.circleMarker([stop.lat, stop.lon], {
              radius: 4,
              color: 'red',
              fillColor: 'red',
              fillOpacity: 0.8
            }).addTo(map).bindPopup(`<b>${stop.name}</b>`);
          });
        }
      }, err => {
        console.error("Location error:", err);
        showToast("Location access denied.");
      });
    }

    // Immediately call function to highlight closest route on load
    showClosestRouteToUser();

    /* ----------------------------
       SECTION: Tom Select Initialization
       ---------------------------- */
    new TomSelect("#originDropdown", {
      maxOptions: 30,
      maxItems: 1,
      placeholder: "Select origin stop...",
      onFocus: function() {
        this.clear();            // Clears any selected value
        this.setTextboxValue(''); // Clears the text input
        this.refreshOptions();    // Refresh the dropdown list
      }
    });

    new TomSelect("#destinationDropdown", {
      maxOptions: 30,
      maxItems: 1,
      placeholder: "Select destination stop...",
      onFocus: function() {
        this.clear();
        this.setTextboxValue('');
        this.refreshOptions();
      }
    });

    new TomSelect("#routeDropdown", {
      maxOptions: 30,
      maxItems: 1,
      placeholder: "Select route...",
      onFocus: function() {
        this.clear();
        this.setTextboxValue('');
        this.refreshOptions();
      }
    });
  </script>
</body>
</html>
