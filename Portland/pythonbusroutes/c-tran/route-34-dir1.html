<!DOCTYPE html>
<html lang="en">
<head>
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EL337T4JX4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EL337T4JX4');
</script>

<meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Route 34 - Direction 1 | MetroFeed Portland</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #0d0d0d;
      color: #cccccc;
      overflow-y: auto;
    }

    body {
      padding-top: 120px;
    }

    .ad-banner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #222;
      padding: 0;
      z-index: 1000;
      box-shadow: 0 2px 2px rgba(0,0,0,0.5);
      text-align: center;
    }

    .ad-banner img {
      width: 100%;
      max-width: 728px;
      max-height: 120px;
      display: block;
      margin: 0 auto;
    }
    .home-button {
      position: fixed;
      top: 120px;
      left: 10px;
      background-color: #4dd0e1;
      color: #0d0d0d;
      padding: 0.5rem 1rem;
      font-weight: bold;
      border-radius: 8px;
      text-decoration: none;
      z-index: 1001;
      box-shadow: 0 0 10px #4dd0e1;
    }

    .home-button:hover {
      background-color: #00bcd4;
      color: #ffffff;
    }

    header {
      background-color: #0d0d0d;
      border-top: 4px solid #4dd0e1;
      border-bottom: 3px solid #4dd0e1;
      padding: 1rem;
      text-align: center;
    }

    header img {
      max-height: 60px;
    }

    h1 {
      text-align: center;
      margin: 1rem 0;
      font-size: 2rem;
      color: #f0f0f0;
    }

    .content-box {
      border-radius: 12px;
      padding: 0;
      margin: 0;
      background-color: #1e1e1e;
    }

    #map {
      width: 100%;
      height: 85vh;
      border: none;
      margin: 0 auto;
      display: block;
      border-radius: 8px;
    }

    .button-bar {
      display: flex;
      justify-content: center;
      margin: 1rem 0;
    }

    .button-bar a, .back-button {
      background: #4dd0e1;
      color: #0d0d0d;
      padding: 0.6rem 1.2rem;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      box-shadow: 0 0 10px #4dd0e1;
    }

    .back-button:hover {
      background-color: #35c0d6;
    }

    .site-footer {
      text-align: center;
      margin-top: 3rem;
      margin-bottom: 120px;
      font-size: 0.85rem;
      color: #aaa;
    }

    .site-footer a {
      color: #00BFFF;
      text-decoration: none;
    }

    .site-footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      .ad-banner {
        padding-top: 1rem;
        padding-bottom: 0rem;
      }
    }
  </style>
</head>

<body>
  <div class="ad-banner">
    <iframe src="https://metrofeedus.com/portland/Ads/route-34-dir1-ad.html" style="border:none; width:100%; max-width: 728px; height:90px;"></iframe>
  </div>

  <header>
    <img src="MetroFeedPortlandLogo.png" alt="MetroFeed Portland">
  </header>

  <div class="disclaimer" style="margin: 1rem auto 0.5rem; max-width: 600px; font-size: 0.8rem; color: #bbb; text-align: center; padding: 0.5rem 1rem; background-color: #111; border: 1px dashed #444; border-radius: 6px;">
    ⚠️ This is a Beta program, work in progress. Please REPORT bugs and pretend to be impressed.
  </div>
  <div class="disclaimer" style="margin: 0 auto 1rem; max-width: 600px; font-size: 0.75rem; color: #888; text-align: center; padding: 0.25rem 1rem;">
    This tool is not affiliated with or endorsed by TriMet. For official schedules and service alerts, visit <a href="https://trimet.org" style="color:#4dd0e1;">trimet.org</a>.
  </div>

  <div style="margin: 2rem 0; text-align: center;">
    <button class="back-button" onclick="history.back()">Back</button>
  </div>

  <h1>Route 34 - Direction 1</h1>

  <div class="content-box">
    <div id="map"></div>
    <div style="text-align:right; font-size: 0.7rem; color: #777; margin-top: 0.5rem;">
      Data courtesy of TriMet.
    </div>
  </div>

  <script>
    if (document.referrer === "" && performance.navigation.type === 0) {
      window.location.href = "/index.html";
    }

    const apiKey = "2C4447D4A42083BCD84DE3B8E";
    const routeNumber = 34;
    const direction = parseInt(1);

    const map = L.map('map', {
      center: [45.6, -122.7],
      zoom: 12,
      minZoom: 12,
      maxZoom: 18,
      maxBounds: [[45.3, -123.1], [45.9, -122.3]],
      maxBoundsViscosity: 1.0
    });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    const shapeOutbound = [
  [45.61745428004275, -122.483205913895],
  [45.617323, -122.484621],
  [45.617127, -122.484618],
  [45.616706, -122.484624],
  [45.616583, -122.48461999999999],
  [45.616485, -122.484602],
  [45.616366, -122.484561],
  [45.616244, -122.484501],
  [45.616139, -122.484431],
  [45.616021, -122.48433099999998],
  [45.61595, -122.48426899999998],
  [45.615882, -122.484226],
  [45.615792, -122.48418599999998],
  [45.615679, -122.48414699999998],
  [45.615526, -122.484107],
  [45.615341, -122.484075],
  [45.615346, -122.48390299999998],
  [45.615357, -122.48371099999999],
  [45.615384, -122.48344099999998],
  [45.615416, -122.483198],
  [45.615444, -122.483029],
  [45.615498, -122.48274299999999],
  [45.615547, -122.482509],
  [45.615593, -122.48233299999998],
  [45.615639, -122.482172],
  [45.6157, -122.48196899999999],
  [45.615781, -122.48171499999998],
  [45.615868, -122.48147499999999],
  [45.615993, -122.48117999999998],
  [45.616029, -122.48110199999999],
  [45.616172, -122.480814],
  [45.616286, -122.48056299999999],
  [45.616408, -122.48028999999998],
  [45.616497, -122.48007399999999],
  [45.616563, -122.47991099999999],
  [45.616606, -122.47979],
  [45.616644, -122.47966999999998],
  [45.61668, -122.47955299999998],
  [45.616723, -122.47938499999998],
  [45.616755, -122.479243],
  [45.61677938410824, -122.47912772967017],
  [45.616779384349414, -122.47912772853003],
  [45.616788, -122.479087],
  [45.616821, -122.478921],
  [45.616842, -122.47879100000002],
  [45.616899, -122.478409],
  [45.616906, -122.4783],
  [45.616928, -122.47804999999998],
  [45.616941, -122.477785],
  [45.616946, -122.47763000000002],
  [45.616947, -122.477489],
  [45.616948, -122.477303],
  [45.616944, -122.47599700000002],
  [45.616180706632804, -122.47598676818546],
  [45.61618070662189, -122.4759867681853],
  [45.614706, -122.475967],
  [45.61287, -122.475966],
  [45.611731, -122.47594599999998],
  [45.610044, -122.475919],
  [45.60958170332742, -122.47591477296551],
  [45.609581703500226, -122.47591477296712],
  [45.606763, -122.47588900000001],
  [45.606392073280404, -122.47589819653024],
  [45.60639207305485, -122.47589819653581],
  [45.605916, -122.47591],
  [45.605898, -122.47590799999999],
  [45.605089, -122.47589799999999],
  [45.60431, -122.47587399999999],
  [45.603907, -122.475864],
  [45.603789, -122.475876],
  [45.603594, -122.475902],
  [45.603351, -122.475966],
  [45.60309, -122.476083],
  [45.602964, -122.47614099999998],
  [45.602372, -122.47653599999998],
  [45.60144, -122.477241],
  [45.600782, -122.47771699999998],
  [45.600575, -122.477873],
  [45.600351, -122.477983],
  [45.60034, -122.477989],
  [45.600319, -122.477999],
  [45.600054, -122.478094],
  [45.599802, -122.47815799999998],
  [45.599585, -122.47819199999999],
  [45.599275, -122.47820499999999],
  [45.598431, -122.47818],
  [45.598162693244376, -122.4781751364334],
  [45.598162693748236, -122.47817513644253],
  [45.597438, -122.47816199999998],
  [45.5967, -122.47814799999999],
  [45.5967, -122.47821099999999],
  [45.596692, -122.47888199999998],
  [45.596684, -122.47954799999998],
  [45.5966799221008, -122.48000132646077],
  [45.59667992209986, -122.48000132656493],
  [45.596678, -122.480215],
  [45.596676, -122.480242],
  [45.596652, -122.48221999999998],
  [45.596644, -122.48288699999999],
  [45.596645479344296, -122.48369546165746],
  [45.596645479344296, -122.4836954616568],
  [45.596646, -122.48398],
  [45.596645, -122.48419700000001],
  [45.596639, -122.484868],
  [45.596639, -122.485547],
  [45.596639, -122.485561],
  [45.596639, -122.48556800000001],
  [45.596634, -122.48604700000001],
  [45.596638, -122.48623000000002],
  [45.596649, -122.48668000000002],
  [45.596671, -122.4869],
  [45.59669, -122.487106],
  [45.596708, -122.48730900000001],
  [45.596728, -122.48754000000001],
  [45.596729, -122.487571],
  [45.596739, -122.487725],
  [45.596744, -122.488026],
  [45.596738, -122.48824],
  [45.59673, -122.48857800000002],
  [45.596732, -122.488907],
  [45.596734, -122.48957500000002],
  [45.596734, -122.489653],
  [45.596732, -122.490244],
  [45.596732, -122.490267],
  [45.596738, -122.490663],
  [45.596746, -122.49091400000002],
  [45.59674476083641, -122.49129318405902],
  [45.596744760836415, -122.49129318405603],
  [45.596744, -122.491526],
  [45.596744, -122.491581],
  [45.596748, -122.492143],
  [45.596747, -122.49225],
  [45.596738, -122.492918],
  [45.596732, -122.49353499999998],
  [45.59673, -122.49358699999999],
  [45.596728, -122.494254],
  [45.596726, -122.49492299999999],
  [45.596724, -122.495536],
  [45.596724, -122.49559099999999],
  [45.596732, -122.496118],
  [45.596732, -122.496219],
  [45.59673, -122.49626],
  [45.596728, -122.496776],
  [45.596728, -122.496928],
  [45.596727, -122.49726],
  [45.596726, -122.49747499999998],
  [45.596725, -122.497597],
  [45.596724, -122.497916],
  [45.59672295862604, -122.49803749362903],
  [45.59672295862603, -122.49803749363022],
  [45.596721, -122.498266],
  [45.59672, -122.49869299999999],
  [45.596719, -122.498934],
  [45.596716, -122.499601],
  [45.596715, -122.499786],
  [45.596714, -122.500016],
  [45.596717, -122.50026999999999],
  [45.59672, -122.50093899999999],
  [45.596725, -122.50156699999998],
  [45.596725, -122.50160699999999],
  [45.596727, -122.501988],
  [45.596728, -122.50227599999998],
  [45.59673, -122.502575],
  [45.596739, -122.503929],
  [45.594947, -122.50389599999998],
  [45.594534, -122.503889],
  [45.594216, -122.50386699999999],
  [45.594207, -122.50431099999999],
  [45.594203, -122.504374],
  [45.594194, -122.504419],
  [45.59418, -122.504465],
  [45.594163, -122.504503],
  [45.594145, -122.504548],
  [45.594105, -122.50465],
  [45.594096, -122.504681],
  [45.59409, -122.50471299999998],
  [45.594089, -122.50474699999998],
  [45.594091, -122.50478],
  [45.594097, -122.50480599999999],
  [45.594133, -122.50489099999999],
  [45.594350412246484, -122.50538781011215]
];

const stopNames = {
  "2911": "Mill Plain &amp; 190th Ave",
  "6079": "SE 192nd Ave &amp; Mill Plain",
  "9028": "Mill Plain Transit Center: Bay A",
  "6083": "SE 34th St &amp; 189th Ave",
  "9004": "Fisher&#x27;s Landing Transit Center: Bay E",
  "9003": "Fisher&#x27;s Landing Transit Center: Bay D",
  "6086": "SE 34th St &amp; 172nd Ave",
  "6084": "SE 34th St &amp; Hiddenbrook",
  "6080": "SE 192nd Ave &amp; 15th St",
  "6081": "SE 192nd Ave &amp; 20th St",
  "6085": "SE 34th St &amp; 177th Ave",
  "6082": "SE 192nd Ave &amp; 31st St"
};

const stops = [
  { stop_id: "9028", name: "Mill Plain Transit Center: Bay A", lat: 45.617402, lon: -122.483196, times: ["6:00 AM", "6:15 AM", "6:25 AM", "6:44 AM", "6:59 AM", "7:14 AM", "7:29 AM", "7:44 AM"] },
  { stop_id: "2911", name: "Mill Plain &amp; 190th Ave", lat: 45.616669, lon: -122.47908, times: ["6:01 AM", "6:16 AM", "6:26 AM", "6:45 AM", "7:00 AM", "7:15 AM", "7:30 AM", "7:45 AM"] },
  { stop_id: "6079", name: "SE 192nd Ave &amp; Mill Plain", lat: 45.616179, lon: -122.476247, times: ["6:01 AM", "6:16 AM", "6:26 AM", "6:45 AM", "7:00 AM", "7:15 AM", "7:30 AM", "7:45 AM"] },
  { stop_id: "6080", name: "SE 192nd Ave &amp; 15th St", lat: 45.609581, lon: -122.476072, times: ["6:02 AM", "6:17 AM", "6:27 AM", "6:46 AM", "7:01 AM", "7:16 AM", "7:31 AM", "7:46 AM"] },
  { stop_id: "6081", name: "SE 192nd Ave &amp; 20th St", lat: 45.606394, lon: -122.476057, times: ["6:03 AM", "6:18 AM", "6:28 AM", "6:47 AM", "7:02 AM", "7:17 AM", "7:32 AM", "7:47 AM"] },
  { stop_id: "6082", name: "SE 192nd Ave &amp; 31st St", lat: 45.598161, lon: -122.478366, times: ["6:05 AM", "6:20 AM", "6:30 AM", "6:49 AM", "7:04 AM", "7:19 AM", "7:34 AM", "7:49 AM"] },
  { stop_id: "6083", name: "SE 34th St &amp; 189th Ave", lat: 45.596771, lon: -122.480003, times: ["6:05 AM", "6:20 AM", "6:30 AM", "6:49 AM", "7:04 AM", "7:19 AM", "7:34 AM", "7:49 AM"] },
  { stop_id: "6084", name: "SE 34th St &amp; Hiddenbrook", lat: 45.596769, lon: -122.483695, times: ["6:06 AM", "6:21 AM", "6:31 AM", "6:50 AM", "7:05 AM", "7:20 AM", "7:35 AM", "7:50 AM"] },
  { stop_id: "6085", name: "SE 34th St &amp; 177th Ave", lat: 45.596867, lon: -122.491294, times: ["6:07 AM", "6:22 AM", "6:32 AM", "6:51 AM", "7:06 AM", "7:21 AM", "7:36 AM", "7:51 AM"] },
  { stop_id: "6086", name: "SE 34th St &amp; 172nd Ave", lat: 45.596809, lon: -122.498039, times: ["6:08 AM", "6:23 AM", "6:33 AM", "6:52 AM", "7:07 AM", "7:22 AM", "7:37 AM", "7:52 AM"] },
  { stop_id: "9003", name: "Fisher&#x27;s Landing Transit Center: Bay D", lat: 45.594456, lon: -122.505134, times: ["6:25 AM", "6:55 AM", "7:25 AM", "7:55 AM", "8:25 AM", "8:55 AM", "9:25 AM", "9:55 AM"] },
  { stop_id: "9004", name: "Fisher&#x27;s Landing Transit Center: Bay E", lat: 45.594386, lon: -122.505356, times: ["6:10 AM", "6:35 AM", "7:10 AM", "7:40 AM", "8:10 AM", "8:40 AM", "1:55 PM", "2:25 PM"] },
]

    const polylineOut = L.polyline(shapeOutbound, { color: 'blue', weight: 4, opacity: 0.7 }).addTo(map);
    map.fitBounds(polylineOut.getBounds());

    const nowPT = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
    const nowMins = nowPT.getHours() * 60 + nowPT.getMinutes();

    stops.forEach(stop => {
      let highlightedTimes = [];
      let foundNext = false;
      stop.times.forEach(timeStr => {
        let cleanTime = timeStr.trim();
        let [h, m] = cleanTime.split(":");
        let schedMins = parseInt(h, 10) * 60 + parseInt(m, 10);
        if (schedMins < nowMins && nowMins - schedMins > 720) {
          schedMins += 1440;
        }
        if (!foundNext && schedMins >= nowMins) {
          highlightedTimes.push(`<span style="background:#4dd0e1; color:#000; padding:2px 6px; border-radius:6px; font-weight:bold;">${cleanTime}</span>`);
          foundNext = true;
        } else {
          highlightedTimes.push(cleanTime);
        }
      });

      L.circleMarker([stop.lat, stop.lon], {
        radius: 6,
        color: '#4dd0e1',
        fillColor: '#4dd0e1',
        fillOpacity: 0.9,
        weight: 1
      })
      .bindPopup(`<strong>${stop.name}</strong><br>${highlightedTimes.join("<br>") || 'No scheduled times'}`)
      .addTo(map);
    });

    let busMarkers = {};
    async function fetchAndDisplay() {
      const res = await fetch(`https://developer.trimet.org/ws/v2/vehicles?route=${routeNumber}&appID=${apiKey}&json=true`);
      const data = await res.json();
      const buses = (data.resultSet.vehicle || []).filter(v => v.routeNumber == routeNumber && v.direction == direction);

      Object.values(busMarkers).forEach(m => map.removeLayer(m));
      busMarkers = {};
      if (!buses.length) return;

      buses.forEach(bus => {
        if (!bus.latitude || !bus.longitude || !bus.blockID) return;
        const icon = L.divIcon({    
           className: '',
           html: `
            <div style="text-align:center;">
              <div style="background:#0071CE;color:#fff;padding:2px 6px;border-radius:6px;font-weight:bold;">${bus.vehicleID}</div>
              <div style="width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:10px solid #00bfff;margin:auto;"></div>
            </div>
          `,
          iconSize: [40, 30], iconAnchor: [20, 30]
        });
        const marker = L.marker([bus.latitude, bus.longitude], { icon }).addTo(map);
        busMarkers[bus.vehicleID] = marker;
      });
    }
    fetchAndDisplay();
    setInterval(fetchAndDisplay, 15000);
  </script>

  <footer class="site-footer">
    <a href="terms.html">Terms of Use</a> &nbsp;|&nbsp;
    <a href="contact.html">Contact Us</a> &nbsp;|&nbsp;
    <a href="report.html">Report a Problem</a> &nbsp;|&nbsp;
    <a href="dmca.html">DMCA</a> &nbsp;|&nbsp;
    <a href="privacy.html">Privacy Policy</a>
  </footer>

  <script>
    if (!localStorage.getItem('cookieConsent')) {
      document.write(`
        <div id="cookie-banner" style="position: fixed; bottom: 0; left: 0; right: 0; background: #333; color: #fff; padding: 1rem; z-index: 1000; font-size: 0.9rem; line-height: 1.4; text-align: center; box-sizing: border-box;">
          📢 We use cookies to improve functionality and analyze traffic.
          By using MetroFeed, you agree to our 
          <a href='privacy.html' style='color: #4dd0e1; text-decoration: underline;'>Privacy Policy</a>.<br>
          <button onclick='localStorage.setItem("cookieConsent", "true"); document.getElementById("cookie-banner").remove();' style='margin-top: 0.5rem; background: #4dd0e1; color: #000; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; font-weight: bold;'>OK</button>
        </div>
      `);
    }
  </script>
</body>
</html>