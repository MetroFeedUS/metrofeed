<!DOCTYPE html>
<html lang="en">
<head>
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EL337T4JX4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EL337T4JX4');
</script>

<meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Route 34 - Direction 0 | MetroFeed Portland</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #0d0d0d;
      color: #cccccc;
      overflow-y: auto;
    }

    body {
      padding-top: 120px;
    }

    .ad-banner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #222;
      padding: 0;
      z-index: 1000;
      box-shadow: 0 2px 2px rgba(0,0,0,0.5);
      text-align: center;
    }

    .ad-banner img {
      width: 100%;
      max-width: 728px;
      max-height: 120px;
      display: block;
      margin: 0 auto;
    }
    .home-button {
      position: fixed;
      top: 120px;
      left: 10px;
      background-color: #4dd0e1;
      color: #0d0d0d;
      padding: 0.5rem 1rem;
      font-weight: bold;
      border-radius: 8px;
      text-decoration: none;
      z-index: 1001;
      box-shadow: 0 0 10px #4dd0e1;
    }

    .home-button:hover {
      background-color: #00bcd4;
      color: #ffffff;
    }

    header {
      background-color: #0d0d0d;
      border-top: 4px solid #4dd0e1;
      border-bottom: 3px solid #4dd0e1;
      padding: 1rem;
      text-align: center;
    }

    header img {
      max-height: 60px;
    }

    h1 {
      text-align: center;
      margin: 1rem 0;
      font-size: 2rem;
      color: #f0f0f0;
    }

    .content-box {
      border-radius: 12px;
      padding: 0;
      margin: 0;
      background-color: #1e1e1e;
    }

    #map {
      width: 100%;
      height: 85vh;
      border: none;
      margin: 0 auto;
      display: block;
      border-radius: 8px;
    }

    .button-bar {
      display: flex;
      justify-content: center;
      margin: 1rem 0;
    }

    .button-bar a, .back-button {
      background: #4dd0e1;
      color: #0d0d0d;
      padding: 0.6rem 1.2rem;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      box-shadow: 0 0 10px #4dd0e1;
    }

    .back-button:hover {
      background-color: #35c0d6;
    }

    .site-footer {
      text-align: center;
      margin-top: 3rem;
      margin-bottom: 120px;
      font-size: 0.85rem;
      color: #aaa;
    }

    .site-footer a {
      color: #00BFFF;
      text-decoration: none;
    }

    .site-footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      .ad-banner {
        padding-top: 1rem;
        padding-bottom: 0rem;
      }
    }
  </style>
</head>

<body>
  <div class="ad-banner">
    <iframe src="https://metrofeedus.com/portland/Ads/route-34-dir0-ad.html" style="border:none; width:100%; max-width: 728px; height:90px;"></iframe>
  </div>

  <header>
    <img src="MetroFeedPortlandLogo.png" alt="MetroFeed Portland">
  </header>

  <div class="disclaimer" style="margin: 1rem auto 0.5rem; max-width: 600px; font-size: 0.8rem; color: #bbb; text-align: center; padding: 0.5rem 1rem; background-color: #111; border: 1px dashed #444; border-radius: 6px;">
    ⚠️ This is a Beta program, work in progress. Please REPORT bugs and pretend to be impressed.
  </div>
  <div class="disclaimer" style="margin: 0 auto 1rem; max-width: 600px; font-size: 0.75rem; color: #888; text-align: center; padding: 0.25rem 1rem;">
    This tool is not affiliated with or endorsed by TriMet. For official schedules and service alerts, visit <a href="https://trimet.org" style="color:#4dd0e1;">trimet.org</a>.
  </div>

  <div style="margin: 2rem 0; text-align: center;">
    <button class="back-button" onclick="history.back()">Back</button>
  </div>

  <h1>Route 34 - Direction 0</h1>

  <div class="content-box">
    <div id="map"></div>
    <div style="text-align:right; font-size: 0.7rem; color: #777; margin-top: 0.5rem;">
      Data courtesy of TriMet.
    </div>
  </div>

  <script>
    if (document.referrer === "" && performance.navigation.type === 0) {
      window.location.href = "/index.html";
    }

    const apiKey = "2C4447D4A42083BCD84DE3B8E";
    const routeNumber = 34;
    const direction = parseInt(0);

    const map = L.map('map', {
      center: [45.6, -122.7],
      zoom: 12,
      minZoom: 12,
      maxZoom: 18,
      maxBounds: [[45.3, -123.1], [45.9, -122.3]],
      maxBoundsViscosity: 1.0
    });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    const shapeOutbound = [
  [45.59435041132248, -122.5053878080007],
  [45.594368, -122.505428],
  [45.594686, -122.50621099999998],
  [45.594702, -122.506223],
  [45.594717, -122.506232],
  [45.594734, -122.506238],
  [45.59475, -122.50623999999999],
  [45.594767, -122.50623999999999],
  [45.594825, -122.506291],
  [45.594871, -122.506328],
  [45.594933, -122.506364],
  [45.595001, -122.50639999999999],
  [45.5951, -122.506449],
  [45.595214, -122.50647499999998],
  [45.595248, -122.506524],
  [45.595391, -122.50642299999998],
  [45.5956, -122.506264],
  [45.595699, -122.50619699999999],
  [45.595774, -122.50613399999999],
  [45.595854, -122.50607499999998],
  [45.595928, -122.50602099999999],
  [45.59599, -122.50597099999999],
  [45.596037, -122.505928],
  [45.596084, -122.505886],
  [45.596124, -122.505856],
  [45.596147, -122.50583199999998],
  [45.596211, -122.505779],
  [45.596285, -122.50569999999999],
  [45.596442, -122.50547199999998],
  [45.596453, -122.505459],
  [45.59651, -122.50532],
  [45.596572, -122.50515399999999],
  [45.596635, -122.50498199999998],
  [45.596678, -122.504827],
  [45.5967, -122.504627],
  [45.596715, -122.50444499999999],
  [45.596725, -122.50426099999999],
  [45.596739, -122.503929],
  [45.59673, -122.502575],
  [45.596729, -122.502276],
  [45.596727, -122.501988],
  [45.596725, -122.501607],
  [45.596725, -122.501567],
  [45.59672, -122.50093899999999],
  [45.596716, -122.50026999999999],
  [45.596714, -122.500016],
  [45.596716, -122.499785],
  [45.596716, -122.499602],
  [45.596719, -122.49893399999999],
  [45.59672, -122.498692],
  [45.596721, -122.498266],
  [45.596724, -122.49791599999999],
  [45.596725, -122.497597],
  [45.596726, -122.49747499999998],
  [45.596726, -122.49726],
  [45.596726444955536, -122.49718613738128],
  [45.596726444954896, -122.49718613748641],
  [45.596728, -122.496928],
  [45.596728, -122.49677500000001],
  [45.59673, -122.49626000000002],
  [45.596732, -122.49621900000001],
  [45.596732, -122.49611800000001],
  [45.596724, -122.49559100000002],
  [45.596724, -122.495536],
  [45.596726, -122.494923],
  [45.596728, -122.494254],
  [45.59673, -122.49358700000002],
  [45.596732, -122.493535],
  [45.596738, -122.492918],
  [45.596747, -122.49225000000001],
  [45.596748, -122.49214300000001],
  [45.59674537161697, -122.49177371218364],
  [45.596745371616954, -122.49177371218182],
  [45.596744, -122.49158100000001],
  [45.596744, -122.491526],
  [45.596746, -122.490914],
  [45.596738, -122.490663],
  [45.596732, -122.490267],
  [45.596732, -122.490244],
  [45.596734, -122.48965300000002],
  [45.596734, -122.48957499999999],
  [45.596732, -122.488907],
  [45.59673, -122.48857800000002],
  [45.596738, -122.48824],
  [45.596744, -122.488026],
  [45.596739, -122.487725],
  [45.596729, -122.487571],
  [45.596728, -122.48754100000001],
  [45.596708, -122.487309],
  [45.59669, -122.487106],
  [45.596671, -122.48690000000002],
  [45.596649, -122.48668000000002],
  [45.596638, -122.48623],
  [45.596634, -122.486047],
  [45.596639, -122.485568],
  [45.596639, -122.485561],
  [45.596639, -122.485547],
  [45.596639, -122.48486799999999],
  [45.596645, -122.484197],
  [45.596646, -122.48398],
  [45.59664504209788, -122.48345650649259],
  [45.59664504209788, -122.48345650649438],
  [45.596644, -122.482887],
  [45.596653, -122.48221999999998],
  [45.596676, -122.480242],
  [45.596678, -122.480215],
  [45.59668070965299, -122.47991377690857],
  [45.59668070965298, -122.47991377691062],
  [45.596684, -122.47954800000001],
  [45.596692, -122.47888000000002],
  [45.5967, -122.478211],
  [45.5967, -122.478148],
  [45.597438, -122.47816200000001],
  [45.59826560665715, -122.47817700193337],
  [45.59826560669535, -122.47817700193406],
  [45.598431, -122.47818],
  [45.599275, -122.478205],
  [45.599585, -122.478192],
  [45.599802, -122.47815800000001],
  [45.600054, -122.478094],
  [45.600319, -122.477999],
  [45.60034, -122.477989],
  [45.600351, -122.47798300000001],
  [45.600576, -122.477873],
  [45.600781, -122.47771800000001],
  [45.60144, -122.477241],
  [45.602372, -122.47653600000001],
  [45.602964, -122.476141],
  [45.60309, -122.47608300000002],
  [45.603351, -122.475966],
  [45.603594, -122.47590200000002],
  [45.603789, -122.475876],
  [45.603907, -122.475865],
  [45.60431, -122.47587400000002],
  [45.605089, -122.47589800000002],
  [45.605898, -122.47590800000002],
  [45.605916, -122.47591],
  [45.606763, -122.475889],
  [45.607565103216984, -122.47589633407392],
  [45.60756510351348, -122.47589633407661],
  [45.610044, -122.47591899999999],
  [45.61079235527177, -122.47593097723315],
  [45.61079235546276, -122.47593097723622],
  [45.611731, -122.475946],
  [45.61287, -122.475966],
  [45.614493969624164, -122.47596688451505],
  [45.61449396965327, -122.47596688451507],
  [45.614706, -122.47596700000001],
  [45.616944, -122.475997],
  [45.616948, -122.477303],
  [45.616947, -122.477489],
  [45.616947, -122.47763000000002],
  [45.616941, -122.477785],
  [45.616928, -122.47805],
  [45.616906, -122.47830000000002],
  [45.616899, -122.47840900000001],
  [45.616842, -122.478791],
  [45.616821, -122.47892100000001],
  [45.616821, -122.478921],
  [45.616788, -122.47908700000002],
  [45.616755, -122.479243],
  [45.616723, -122.47938500000001],
  [45.61668, -122.47955300000001],
  [45.616644, -122.47967000000001],
  [45.616606, -122.47979],
  [45.616563, -122.47991100000002],
  [45.616497, -122.48007400000002],
  [45.616408, -122.48029],
  [45.616286, -122.480563],
  [45.616172, -122.480814],
  [45.61603, -122.481101],
  [45.615993, -122.48118],
  [45.615868, -122.481475],
  [45.615781, -122.481715],
  [45.6157, -122.48196900000002],
  [45.615639, -122.482172],
  [45.615593, -122.482333],
  [45.615547, -122.48250900000001],
  [45.615498, -122.48274300000001],
  [45.615444, -122.483029],
  [45.615416, -122.48319800000002],
  [45.615384, -122.483441],
  [45.615357, -122.483711],
  [45.615346, -122.48390300000001],
  [45.615341, -122.484075],
  [45.615526, -122.48410700000001],
  [45.615679, -122.484147],
  [45.615792, -122.48418599999998],
  [45.615882, -122.48422600000002],
  [45.61595, -122.484269],
  [45.616021, -122.484331],
  [45.616139, -122.484431],
  [45.616244, -122.48450100000001],
  [45.616366, -122.484561],
  [45.616485, -122.484602],
  [45.616583, -122.48462000000002],
  [45.616706, -122.484624],
  [45.617126, -122.484617],
  [45.617323, -122.484621],
  [45.61745428006351, -122.48320591367126]
];

const stopNames = {
  "6090": "SE 34th St &amp; 189th Ave",
  "6093": "SE 192nd Ave &amp; 15th St",
  "6092": "SE 192nd Ave &amp; 20th St",
  "6094": "SE 192nd Ave &amp; Westridge Blvd",
  "9028": "Mill Plain Transit Center: Bay A",
  "6091": "SE 192nd Ave &amp; 31st St",
  "6088": "SE 34th St &amp; 176th Ave",
  "9004": "Fisher&#x27;s Landing Transit Center: Bay E",
  "6089": "SE 34th St &amp; Hiddenbrook Dr",
  "6087": "SE 34th St &amp; 172nd Ave",
  "2920": "Mill Plain &amp; 190th Ave"
};

const stops = [
  { stop_id: "9004", name: "Fisher&#x27;s Landing Transit Center: Bay E", lat: 45.594386, lon: -122.505356, times: ["6:05 AM", "6:15 AM", "6:32 AM", "6:47 AM", "7:02 AM", "7:17 AM", "7:32 AM", "7:47 AM"] },
  { stop_id: "6087", name: "SE 34th St &amp; 172nd Ave", lat: 45.596634, lon: -122.497185, times: ["6:06 AM", "6:16 AM", "6:33 AM", "6:48 AM", "7:03 AM", "7:18 AM", "7:33 AM", "7:48 AM"] },
  { stop_id: "6088", name: "SE 34th St &amp; 176th Ave", lat: 45.596588, lon: -122.491776, times: ["6:07 AM", "6:17 AM", "6:34 AM", "6:49 AM", "7:04 AM", "7:19 AM", "7:34 AM", "7:49 AM"] },
  { stop_id: "6089", name: "SE 34th St &amp; Hiddenbrook Dr", lat: 45.596513, lon: -122.483457, times: ["6:08 AM", "6:18 AM", "6:35 AM", "6:50 AM", "7:05 AM", "7:20 AM", "7:35 AM", "7:50 AM"] },
  { stop_id: "6090", name: "SE 34th St &amp; 189th Ave", lat: 45.596584, lon: -122.479912, times: ["6:08 AM", "6:18 AM", "6:36 AM", "6:51 AM", "7:06 AM", "7:21 AM", "7:36 AM", "7:51 AM"] },
  { stop_id: "6091", name: "SE 192nd Ave &amp; 31st St", lat: 45.598267, lon: -122.47802, times: ["6:09 AM", "6:19 AM", "6:37 AM", "6:52 AM", "7:07 AM", "7:22 AM", "7:37 AM", "7:52 AM"] },
  { stop_id: "6092", name: "SE 192nd Ave &amp; 20th St", lat: 45.607566, lon: -122.475696, times: ["5:56 AM", "6:11 AM", "6:21 AM", "6:39 AM", "6:54 AM", "7:09 AM", "7:24 AM", "7:39 AM"] },
  { stop_id: "6093", name: "SE 192nd Ave &amp; 15th St", lat: 45.610794, lon: -122.475721, times: ["5:56 AM", "6:11 AM", "6:21 AM", "6:40 AM", "6:55 AM", "7:10 AM", "7:25 AM", "7:40 AM"] },
  { stop_id: "6094", name: "SE 192nd Ave &amp; Westridge Blvd", lat: 45.614494, lon: -122.475853, times: ["5:57 AM", "6:12 AM", "6:22 AM", "6:41 AM", "6:56 AM", "7:11 AM", "7:26 AM", "7:41 AM"] },
  { stop_id: "2920", name: "Mill Plain &amp; 190th Ave", lat: 45.616879, lon: -122.478943, times: ["5:58 AM", "6:13 AM", "6:23 AM", "6:42 AM", "6:57 AM", "7:12 AM", "7:27 AM", "7:42 AM"] },
  { stop_id: "9028", name: "Mill Plain Transit Center: Bay A", lat: 45.617402, lon: -122.483196, times: ["6:00 AM", "6:15 AM", "6:25 AM", "6:44 AM", "6:59 AM", "7:14 AM", "7:29 AM", "7:44 AM"] },
]

    const polylineOut = L.polyline(shapeOutbound, { color: 'blue', weight: 4, opacity: 0.7 }).addTo(map);
    map.fitBounds(polylineOut.getBounds());

    const nowPT = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
    const nowMins = nowPT.getHours() * 60 + nowPT.getMinutes();

    stops.forEach(stop => {
      let highlightedTimes = [];
      let foundNext = false;
      stop.times.forEach(timeStr => {
        let cleanTime = timeStr.trim();
        let [h, m] = cleanTime.split(":");
        let schedMins = parseInt(h, 10) * 60 + parseInt(m, 10);
        if (schedMins < nowMins && nowMins - schedMins > 720) {
          schedMins += 1440;
        }
        if (!foundNext && schedMins >= nowMins) {
          highlightedTimes.push(`<span style="background:#4dd0e1; color:#000; padding:2px 6px; border-radius:6px; font-weight:bold;">${cleanTime}</span>`);
          foundNext = true;
        } else {
          highlightedTimes.push(cleanTime);
        }
      });

      L.circleMarker([stop.lat, stop.lon], {
        radius: 6,
        color: '#4dd0e1',
        fillColor: '#4dd0e1',
        fillOpacity: 0.9,
        weight: 1
      })
      .bindPopup(`<strong>${stop.name}</strong><br>${highlightedTimes.join("<br>") || 'No scheduled times'}`)
      .addTo(map);
    });

    let busMarkers = {};
    async function fetchAndDisplay() {
      const res = await fetch(`https://developer.trimet.org/ws/v2/vehicles?route=${routeNumber}&appID=${apiKey}&json=true`);
      const data = await res.json();
      const buses = (data.resultSet.vehicle || []).filter(v => v.routeNumber == routeNumber && v.direction == direction);

      Object.values(busMarkers).forEach(m => map.removeLayer(m));
      busMarkers = {};
      if (!buses.length) return;

      buses.forEach(bus => {
        if (!bus.latitude || !bus.longitude || !bus.blockID) return;
        const icon = L.divIcon({    
           className: '',
           html: `
            <div style="text-align:center;">
              <div style="background:#0071CE;color:#fff;padding:2px 6px;border-radius:6px;font-weight:bold;">${bus.vehicleID}</div>
              <div style="width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:10px solid #00bfff;margin:auto;"></div>
            </div>
          `,
          iconSize: [40, 30], iconAnchor: [20, 30]
        });
        const marker = L.marker([bus.latitude, bus.longitude], { icon }).addTo(map);
        busMarkers[bus.vehicleID] = marker;
      });
    }
    fetchAndDisplay();
    setInterval(fetchAndDisplay, 15000);
  </script>

  <footer class="site-footer">
    <a href="terms.html">Terms of Use</a> &nbsp;|&nbsp;
    <a href="contact.html">Contact Us</a> &nbsp;|&nbsp;
    <a href="report.html">Report a Problem</a> &nbsp;|&nbsp;
    <a href="dmca.html">DMCA</a> &nbsp;|&nbsp;
    <a href="privacy.html">Privacy Policy</a>
  </footer>

  <script>
    if (!localStorage.getItem('cookieConsent')) {
      document.write(`
        <div id="cookie-banner" style="position: fixed; bottom: 0; left: 0; right: 0; background: #333; color: #fff; padding: 1rem; z-index: 1000; font-size: 0.9rem; line-height: 1.4; text-align: center; box-sizing: border-box;">
          📢 We use cookies to improve functionality and analyze traffic.
          By using MetroFeed, you agree to our 
          <a href='privacy.html' style='color: #4dd0e1; text-decoration: underline;'>Privacy Policy</a>.<br>
          <button onclick='localStorage.setItem("cookieConsent", "true"); document.getElementById("cookie-banner").remove();' style='margin-top: 0.5rem; background: #4dd0e1; color: #000; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; font-weight: bold;'>OK</button>
        </div>
      `);
    }
  </script>
</body>
</html>