<!DOCTYPE html>
<html lang="en">
<head>
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EL337T4JX4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EL337T4JX4');
</script>

<meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Route 47 - Direction 0 | MetroFeed Portland</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #0d0d0d;
      color: #cccccc;
      overflow-y: auto;
    }

    body {
      padding-top: 120px;
    }

    .ad-banner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #222;
      padding: 0;
      z-index: 1000;
      box-shadow: 0 2px 2px rgba(0,0,0,0.5);
      text-align: center;
    }

    .ad-banner img {
      width: 100%;
      max-width: 728px;
      max-height: 120px;
      display: block;
      margin: 0 auto;
    }
    .home-button {
      position: fixed;
      top: 120px;
      left: 10px;
      background-color: #4dd0e1;
      color: #0d0d0d;
      padding: 0.5rem 1rem;
      font-weight: bold;
      border-radius: 8px;
      text-decoration: none;
      z-index: 1001;
      box-shadow: 0 0 10px #4dd0e1;
    }

    .home-button:hover {
      background-color: #00bcd4;
      color: #ffffff;
    }

    header {
      background-color: #0d0d0d;
      border-top: 4px solid #4dd0e1;
      border-bottom: 3px solid #4dd0e1;
      padding: 1rem;
      text-align: center;
    }

    header img {
      max-height: 60px;
    }

    h1 {
      text-align: center;
      margin: 1rem 0;
      font-size: 2rem;
      color: #f0f0f0;
    }

    .content-box {
      border-radius: 12px;
      padding: 0;
      margin: 0;
      background-color: #1e1e1e;
    }

    #map {
      width: 100%;
      height: 85vh;
      border: none;
      margin: 0 auto;
      display: block;
      border-radius: 8px;
    }

    .button-bar {
      display: flex;
      justify-content: center;
      margin: 1rem 0;
    }

    .button-bar a, .back-button {
      background: #4dd0e1;
      color: #0d0d0d;
      padding: 0.6rem 1.2rem;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      box-shadow: 0 0 10px #4dd0e1;
    }

    .back-button:hover {
      background-color: #35c0d6;
    }

    .site-footer {
      text-align: center;
      margin-top: 3rem;
      margin-bottom: 120px;
      font-size: 0.85rem;
      color: #aaa;
    }

    .site-footer a {
      color: #00BFFF;
      text-decoration: none;
    }

    .site-footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      .ad-banner {
        padding-top: 1rem;
        padding-bottom: 0rem;
      }
    }
  </style>
</head>

<body>
  <div class="ad-banner">
    <iframe src="https://metrofeedus.com/portland/Ads/route-47-dir0-ad.html" style="border:none; width:100%; max-width: 728px; height:90px;"></iframe>
  </div>

  <header>
    <img src="MetroFeedPortlandLogo.png" alt="MetroFeed Portland">
  </header>

  <div class="disclaimer" style="margin: 1rem auto 0.5rem; max-width: 600px; font-size: 0.8rem; color: #bbb; text-align: center; padding: 0.5rem 1rem; background-color: #111; border: 1px dashed #444; border-radius: 6px;">
    ‚ö†Ô∏è This is a Beta program, work in progress. Please REPORT bugs and pretend to be impressed.
  </div>
  <div class="disclaimer" style="margin: 0 auto 1rem; max-width: 600px; font-size: 0.75rem; color: #888; text-align: center; padding: 0.25rem 1rem;">
    This tool is not affiliated with or endorsed by TriMet. For official schedules and service alerts, visit <a href="https://trimet.org" style="color:#4dd0e1;">trimet.org</a>.
  </div>

  <div style="margin: 2rem 0; text-align: center;">
    <button class="back-button" onclick="history.back()">Back</button>
  </div>

  <h1>Route 47 - Direction 0</h1>

  <div class="content-box">
    <div id="map"></div>
    <div style="text-align:right; font-size: 0.7rem; color: #777; margin-top: 0.5rem;">
      Data courtesy of TriMet.
    </div>
  </div>

  <script>
    if (document.referrer === "" && performance.navigation.type === 0) {
      window.location.href = "/index.html";
    }

    const apiKey = "2C4447D4A42083BCD84DE3B8E";
    const routeNumber = 47;
    const direction = parseInt(0);

    const map = L.map('map', {
      center: [45.6, -122.7],
      zoom: 12,
      minZoom: 12,
      maxZoom: 18,
      maxBounds: [[45.3, -123.1], [45.9, -122.3]],
      maxBoundsViscosity: 1.0
    });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    const shapeOutbound = [
  [45.65607710134459, -122.58463161060324],
  [45.655972, -122.585224],
  [45.656179, -122.585276],
  [45.656395, -122.58421100000001],
  [45.656062, -122.584057],
  [45.656241, -122.582978],
  [45.656169, -122.58336900000002],
  [45.656112, -122.583691],
  [45.656169, -122.58336900000002],
  [45.656241, -122.582978],
  [45.656299, -122.5826],
  [45.656331, -122.582338],
  [45.656376, -122.582094],
  [45.656408, -122.581897],
  [45.656455, -122.581718],
  [45.65651, -122.58151700000002],
  [45.656551, -122.581383],
  [45.65659, -122.58124700000002],
  [45.656631, -122.58109300000001],
  [45.656704, -122.58085000000001],
  [45.656812, -122.58046500000002],
  [45.65691, -122.580165],
  [45.656983, -122.579915],
  [45.657052, -122.57974400000002],
  [45.65712, -122.57961100000001],
  [45.657196, -122.57948600000002],
  [45.657261, -122.57941100000001],
  [45.657359, -122.57931100000002],
  [45.657435, -122.57924400000002],
  [45.657489, -122.579201],
  [45.657595, -122.579165],
  [45.657704, -122.57913800000001],
  [45.657847, -122.57911300000002],
  [45.658036, -122.579105],
  [45.658137, -122.579097],
  [45.658305, -122.57908400000001],
  [45.658189, -122.577293],
  [45.658171, -122.576964],
  [45.658148, -122.576757],
  [45.658132, -122.57665000000001],
  [45.658108, -122.57654400000001],
  [45.658076, -122.57645000000001],
  [45.658041, -122.57636100000002],
  [45.65799, -122.576271],
  [45.657977, -122.576244],
  [45.657954, -122.57619900000002],
  [45.657894, -122.5761],
  [45.657532, -122.575471],
  [45.658197, -122.574769],
  [45.658454, -122.57447100000002],
  [45.658551, -122.57435900000002],
  [45.658685, -122.57417900000002],
  [45.65886, -122.573957],
  [45.658983, -122.57379400000002],
  [45.659037, -122.573724],
  [45.659169, -122.573526],
  [45.659273, -122.57337100000001],
  [45.659376, -122.573209],
  [45.659478, -122.573056],
  [45.659572, -122.57291200000002],
  [45.659709, -122.572698],
  [45.65987, -122.572454],
  [45.659939, -122.572343],
  [45.660017, -122.572217],
  [45.660105, -122.572058],
  [45.660201, -122.57188],
  [45.660906, -122.57055100000001],
  [45.661555, -122.56908],
  [45.661843, -122.568491],
  [45.66232, -122.567528],
  [45.662879, -122.56634400000002],
  [45.663438, -122.56516100000002],
  [45.663711, -122.564467],
  [45.664082, -122.56348900000002],
  [45.664619, -122.56212400000001],
  [45.664715, -122.56190500000001],
  [45.664938, -122.561403],
  [45.665074, -122.561065],
  [45.665111, -122.560975],
  [45.665163, -122.56084500000001],
  [45.665377, -122.560288],
  [45.665532, -122.559795],
  [45.665589, -122.55956700000002],
  [45.665679, -122.55921900000001],
  [45.665791, -122.558729],
  [45.665938, -122.558081],
  [45.666079, -122.557495],
  [45.666187, -122.55704200000001],
  [45.666352, -122.55630100000002],
  [45.666689, -122.55492900000002],
  [45.666952, -122.553878],
  [45.667262, -122.552632],
  [45.667279, -122.55257000000002],
  [45.667458, -122.55258100000002],
  [45.667882, -122.55259],
  [45.668214, -122.55259600000001],
  [45.668734, -122.55259600000001],
  [45.669921, -122.55256800000001],
  [45.670635, -122.552565],
  [45.674589, -122.55257700000001],
  [45.676649, -122.552555],
  [45.676694, -122.552555],
  [45.677838, -122.55253900000001],
  [45.679091, -122.552574],
  [45.680467, -122.55256900000002],
  [45.680807, -122.552566],
  [45.681354, -122.552561],
  [45.682041, -122.552556],
  [45.682183, -122.552555],
  [45.682824, -122.552563],
  [45.683315, -122.55256800000001],
  [45.685661, -122.55257900000001],
  [45.687401, -122.552556],
  [45.687648, -122.55256900000002],
  [45.687771, -122.552575],
  [45.688644, -122.55262400000001],
  [45.690525, -122.552734],
  [45.691364, -122.552781],
  [45.692254, -122.5528],
  [45.69235, -122.55280400000001],
  [45.692534, -122.55280300000001],
  [45.69257, -122.55280300000001],
  [45.693432, -122.55279],
  [45.694334, -122.55279400000002],
  [45.695311, -122.552798],
  [45.695786, -122.55279],
  [45.696067, -122.55279300000001],
  [45.696164, -122.55279200000001],
  [45.697433, -122.55278200000001],
  [45.697916, -122.55278],
  [45.698905, -122.552779],
  [45.699026, -122.552771],
  [45.699276, -122.552772],
  [45.699969, -122.55276400000001],
  [45.700896, -122.552763],
  [45.701658, -122.552763],
  [45.701834, -122.55276700000002],
  [45.703181, -122.552835],
  [45.703707, -122.55284000000002],
  [45.704083, -122.552836],
  [45.704255, -122.55283400000002],
  [45.704648, -122.55283000000001],
  [45.704891, -122.552829],
  [45.705278, -122.55282200000002],
  [45.705654, -122.552817],
  [45.705994, -122.552799],
  [45.706442, -122.55277600000001],
  [45.707357, -122.55273000000001],
  [45.707966, -122.552713],
  [45.708506, -122.55271900000001],
  [45.70923, -122.55270100000001],
  [45.709729, -122.552695],
  [45.70986, -122.552694],
  [45.710202, -122.55269100000001],
  [45.710817, -122.55268200000002],
  [45.711142, -122.552677],
  [45.711707, -122.55267100000002],
  [45.712294, -122.55266100000001],
  [45.712823, -122.552658],
  [45.71297, -122.552656],
  [45.713566, -122.552646],
  [45.714445, -122.55263500000001],
  [45.715058, -122.552629],
  [45.715668, -122.552622],
  [45.71658, -122.55260900000002],
  [45.717063, -122.55259700000002],
  [45.718656, -122.552566],
  [45.718857, -122.552562],
  [45.718902, -122.552561],
  [45.71978, -122.552546],
  [45.720699, -122.55253900000001],
  [45.722523, -122.552529],
  [45.723187, -122.55252400000002],
  [45.724953, -122.552501],
  [45.72533, -122.55247500000002],
  [45.725867, -122.552462],
  [45.726182, -122.55246],
  [45.726457, -122.55245500000001],
  [45.728067, -122.552453],
  [45.728942, -122.552394],
  [45.729767, -122.55231400000001],
  [45.730359, -122.55218600000002],
  [45.73137, -122.55198500000002],
  [45.732515, -122.551763],
  [45.733634, -122.551615],
  [45.73398, -122.551579],
  [45.734634, -122.55153500000002],
  [45.735569, -122.551502],
  [45.737102, -122.55152],
  [45.737153, -122.55152],
  [45.73721, -122.551521],
  [45.738928, -122.55154400000002],
  [45.73986, -122.55156400000001],
  [45.740256, -122.551567],
  [45.74136, -122.551578],
  [45.741545, -122.55158],
  [45.742102, -122.551587],
  [45.74223, -122.55158300000001],
  [45.742376, -122.551596],
  [45.743397, -122.55161000000001],
  [45.743634, -122.55160200000002],
  [45.743994, -122.551618],
  [45.744354, -122.55162000000001],
  [45.74469, -122.551605],
  [45.745362, -122.55150600000002],
  [45.745551, -122.551467],
  [45.745713, -122.55142200000002],
  [45.746061, -122.551312],
  [45.746289, -122.551232],
  [45.746709, -122.551058],
  [45.746975, -122.550931],
  [45.74718, -122.55082900000001],
  [45.747464, -122.550666],
  [45.748019, -122.550274],
  [45.748029, -122.55026600000001],
  [45.748528, -122.549887],
  [45.748745, -122.549717],
  [45.749091, -122.54946000000001],
  [45.749892, -122.54885000000002],
  [45.750011, -122.54875300000002],
  [45.750365, -122.548488],
  [45.750701, -122.548259],
  [45.75117, -122.54799300000002],
  [45.751316, -122.547919],
  [45.751625, -122.54779],
  [45.751957, -122.547652],
  [45.752545, -122.547471],
  [45.752811, -122.54739900000001],
  [45.753045, -122.54735500000001],
  [45.753404, -122.547302],
  [45.753685, -122.547275],
  [45.754143, -122.547264],
  [45.754524, -122.547273],
  [45.755272, -122.547285],
  [45.756009, -122.547282],
  [45.756182, -122.54728700000001],
  [45.756312, -122.547292],
  [45.756843, -122.54729000000002],
  [45.757016, -122.547296],
  [45.758195, -122.54730500000001],
  [45.758905, -122.547322],
  [45.758942, -122.547323],
  [45.759062, -122.54731800000002],
  [45.760362, -122.547323],
  [45.760507, -122.54731900000002],
  [45.761247, -122.547332],
  [45.762498, -122.54734300000001],
  [45.766233, -122.54737500000002],
  [45.770295, -122.547422],
  [45.775328, -122.54751],
  [45.775737, -122.54751600000002],
  [45.780737, -122.547577],
  [45.780746433969, -122.54596814544124],
  [45.78074643393898, -122.54596815055939],
  [45.78075, -122.54535999999999],
  [45.780761, -122.544682],
  [45.780771, -122.54321],
  [45.780775642695836, -122.54292591123088],
  [45.78077564269579, -122.54292591123448],
  [45.780813, -122.54064000000001],
  [45.78082119072455, -122.5400065839681],
  [45.7808211907245, -122.54000658397197],
  [45.780834, -122.53901599999999],
  [45.780846, -122.538745],
  [45.78086, -122.538271],
  [45.780869, -122.537898],
  [45.780876, -122.537349],
  [45.780878, -122.536917],
  [45.780872, -122.53674299999999],
  [45.78087200158423, -122.53674236313884],
  [45.780873, -122.536341],
  [45.780885, -122.535306],
  [45.780903, -122.53429400000002],
  [45.780919, -122.533027],
  [45.78092964588951, -122.53216371514158],
  [45.78092964588948, -122.53216371514408],
  [45.78093, -122.53213500000001],
  [45.780935, -122.531685],
  [45.780948, -122.530218],
  [45.78095098183994, -122.52999926074186],
  [45.78095098183992, -122.52999926074318],
  [45.780962, -122.529191],
  [45.78119535484666, -122.52919875694782],
  [45.78119535484802, -122.52919875694786],
  [45.781684, -122.529215],
  [45.781882, -122.52922899999999],
  [45.782021, -122.529235],
  [45.782159, -122.52922899999999],
  [45.78228, -122.529218],
  [45.782388, -122.529199],
  [45.782514, -122.529163],
  [45.782763, -122.529061],
  [45.783126, -122.528913],
  [45.783255, -122.528857],
  [45.783366, -122.528811],
  [45.783475, -122.528765],
  [45.783514, -122.52874999999999],
  [45.783669, -122.528682],
  [45.783831, -122.52860699999998],
  [45.783933, -122.528551],
  [45.784041, -122.52849],
  [45.78416, -122.528414],
  [45.784286, -122.52832600000002],
  [45.784311, -122.52830599999999],
  [45.784413, -122.52822700000002],
  [45.784485, -122.528166],
  [45.784566, -122.528101],
  [45.784657, -122.52802],
  [45.784742, -122.527941],
  [45.784834, -122.52784500000001],
  [45.784918, -122.52774799999999],
  [45.785039, -122.52761800000002],
  [45.785205, -122.52740100000001],
  [45.785291, -122.527289],
  [45.785352, -122.52719499999999],
  [45.785401, -122.52713000000001],
  [45.785446, -122.52706799999999],
  [45.785484, -122.527022],
  [45.78552, -122.52698200000002],
  [45.785593, -122.52692200000001],
  [45.785646, -122.526888],
  [45.785699, -122.52686400000002],
  [45.785756, -122.526843],
  [45.785833, -122.526828],
  [45.785936, -122.52682299999998],
  [45.786112, -122.52682299999998],
  [45.786465, -122.526819],
  [45.786948, -122.52681],
  [45.786994, -122.52681],
  [45.787302, -122.526806],
  [45.787949, -122.52678999999999],
  [45.788253, -122.52676699999999],
  [45.78944, -122.526761],
  [45.790663, -122.526745],
  [45.791741, -122.526731],
  [45.791904, -122.526729],
  [45.792405, -122.526722],
  [45.793132, -122.526713],
  [45.793248, -122.52671],
  [45.793726, -122.5267],
  [45.794304, -122.52669099999999],
  [45.794617, -122.526689],
  [45.795238, -122.52668600000001],
  [45.795493, -122.526685],
  [45.795842, -122.526688],
  [45.795998, -122.52669500000002],
  [45.796233, -122.526697],
  [45.796483, -122.526706],
  [45.797365, -122.526717],
  [45.797894, -122.526715],
  [45.798293, -122.526717],
  [45.799131, -122.526734],
  [45.799304, -122.526738],
  [45.799844, -122.526751],
  [45.800262, -122.52676499999998],
  [45.800495, -122.526771],
  [45.800917, -122.52678500000002],
  [45.801842, -122.52681],
  [45.802752, -122.52682499999999],
  [45.80289, -122.526826],
  [45.803687, -122.526821],
  [45.804601, -122.52685],
  [45.805263, -122.526869],
  [45.80535, -122.52687],
  [45.805534, -122.52686200000001],
  [45.805625, -122.526842],
  [45.805717, -122.52682299999998],
  [45.805815, -122.526799],
  [45.805863, -122.52677199999998],
  [45.805975, -122.526722],
  [45.806058, -122.526668],
  [45.806131, -122.526616],
  [45.806194, -122.52656399999998],
  [45.806263, -122.526502],
  [45.806327, -122.526441],
  [45.806385, -122.526375],
  [45.806447, -122.526303],
  [45.806515, -122.526217],
  [45.80658, -122.526122],
  [45.806628, -122.52604299999999],
  [45.806691, -122.52593899999998],
  [45.806893, -122.525565],
  [45.807282, -122.524836],
  [45.807518, -122.52440400000002],
  [45.807584, -122.524296],
  [45.807625, -122.52423099999999],
  [45.807742, -122.524033],
  [45.807895, -122.523795],
  [45.808122, -122.523451],
  [45.808247, -122.523259],
  [45.808451, -122.52295100000002],
  [45.808623, -122.52267599999999],
  [45.808721, -122.52254199999999],
  [45.808774, -122.522465],
  [45.808827, -122.52239600000001],
  [45.808875, -122.522334],
  [45.808926, -122.522274],
  [45.808976, -122.52221999999999],
  [45.809024, -122.522173],
  [45.809074, -122.522127],
  [45.809128, -122.522082],
  [45.809184, -122.52203799999998],
  [45.809247, -122.521995],
  [45.809307, -122.52195600000002],
  [45.809369, -122.52191999999998],
  [45.809424, -122.52189399999999],
  [45.809478, -122.52186899999998],
  [45.809538, -122.521851],
  [45.809597, -122.52183],
  [45.809661, -122.521814],
  [45.809712, -122.52180600000001],
  [45.809766, -122.521798],
  [45.809826, -122.52179199999999],
  [45.809871, -122.521785],
  [45.809913, -122.52178000000002],
  [45.810042, -122.521772],
  [45.812718, -122.521785],
  [45.813211, -122.521786],
  [45.813583, -122.52179199999999],
  [45.81441, -122.521786],
  [45.814672, -122.521797],
  [45.815065, -122.521797],
  [45.81545, -122.521793],
  [45.816315, -122.521794],
  [45.817157, -122.521798],
  [45.817332, -122.521794],
  [45.81868, -122.521795],
  [45.819611, -122.521795],
  [45.82042, -122.521785],
  [45.820906, -122.521779],
  [45.820982, -122.52178000000002],
  [45.822453, -122.52177599999999],
  [45.822646, -122.521775],
  [45.822729, -122.52177399999998],
  [45.823595, -122.521781],
  [45.823691, -122.521779],
  [45.823798, -122.521766],
  [45.823885, -122.521747],
  [45.823968, -122.52171599999998],
  [45.824031, -122.521686],
  [45.824085, -122.521654],
  [45.824124, -122.52162599999998],
  [45.824148, -122.521609],
  [45.824219, -122.521545],
  [45.824279, -122.521479],
  [45.824346, -122.52138999999998],
  [45.8244, -122.52129499999998],
  [45.824439, -122.521208],
  [45.824478, -122.521111],
  [45.824505, -122.521025],
  [45.824533, -122.520921],
  [45.824551, -122.520773],
  [45.824564, -122.520623],
  [45.824568, -122.520159],
  [45.824576, -122.51918200000001],
  [45.824573, -122.51904099999999],
  [45.824568, -122.518676],
  [45.824567, -122.517997],
  [45.824565, -122.51784200000002],
  [45.824567, -122.517378],
  [45.824564, -122.516682],
  [45.824571, -122.51655099999999],
  [45.824565, -122.514928],
  [45.824569, -122.51432299999999],
  [45.82457, -122.51408200000002],
  [45.824563, -122.513901],
  [45.824558, -122.51378],
  [45.824544, -122.513681],
  [45.824529, -122.51357999999999],
  [45.824516, -122.513503],
  [45.824497, -122.513416],
  [45.824478, -122.513343],
  [45.824456, -122.513276],
  [45.824428, -122.513199],
  [45.824403, -122.51314000000002],
  [45.824379, -122.51308000000002],
  [45.824349, -122.513023],
  [45.824319, -122.51296499999998],
  [45.824291, -122.51291100000002],
  [45.824263, -122.512862],
  [45.824207, -122.512765],
  [45.824138, -122.51265900000001],
  [45.824077, -122.512573],
  [45.824005, -122.51247400000001],
  [45.823904, -122.512344],
  [45.82382, -122.512228],
  [45.823748, -122.512119],
  [45.823712, -122.512061],
  [45.823644, -122.511934],
  [45.823613, -122.511865],
  [45.823582, -122.51179599999999],
  [45.823561, -122.511732],
  [45.823541, -122.511667],
  [45.823524, -122.5116],
  [45.82351, -122.51153699999999],
  [45.823497, -122.511452],
  [45.823487, -122.511388],
  [45.823479, -122.511316],
  [45.823473, -122.511246],
  [45.82347, -122.51117],
  [45.82347, -122.511106],
  [45.823471, -122.51103700000002],
  [45.823473, -122.51096100000001],
  [45.82348, -122.510885],
  [45.823491, -122.51080100000001],
  [45.823501, -122.51071099999999],
  [45.823517, -122.510615],
  [45.823557, -122.51033800000002],
  [45.823655, -122.50978],
  [45.823697, -122.509541],
  [45.82374, -122.50928500000002],
  [45.823764, -122.509132],
  [45.823787, -122.508974],
  [45.823795, -122.508884],
  [45.8238, -122.50876999999998],
  [45.823804, -122.50866300000001],
  [45.823804, -122.50854500000001],
  [45.823802, -122.50843199999998],
  [45.823793, -122.508333],
  [45.823779, -122.50823],
  [45.823764, -122.508139],
  [45.823739, -122.50801299999999],
  [45.82371, -122.50790600000002],
  [45.823683, -122.507813],
  [45.823653, -122.50772100000002],
  [45.823615, -122.50762],
  [45.823577, -122.507534],
  [45.823541, -122.50746200000002],
  [45.823498, -122.507385],
  [45.823445, -122.507297],
  [45.823395, -122.50721299999998],
  [45.823172, -122.506859],
  [45.823131, -122.506787],
  [45.823094, -122.50671000000001],
  [45.823064, -122.506642],
  [45.823041, -122.50657800000002],
  [45.823021, -122.50651100000002],
  [45.823011, -122.50645800000001],
  [45.822999, -122.50639300000002],
  [45.822995, -122.506324],
  [45.822993, -122.506255],
  [45.822994, -122.506197],
  [45.822999, -122.506124],
  [45.823012, -122.506052],
  [45.823032, -122.50597200000001],
  [45.823052, -122.50591200000001],
  [45.82308, -122.50584500000001],
  [45.823113, -122.505782],
  [45.823154, -122.50572700000001],
  [45.823202, -122.50566900000001],
  [45.823248, -122.505622],
  [45.823329, -122.505557],
  [45.823447, -122.505473],
  [45.823536, -122.505423],
  [45.823964, -122.505175],
  [45.824059, -122.50510899999999],
  [45.824122, -122.50505799999999],
  [45.824183, -122.505],
  [45.824235, -122.50493799999998],
  [45.824288, -122.504872],
  [45.824328, -122.50481000000002],
  [45.824367, -122.50474],
  [45.8244, -122.504671],
  [45.824433, -122.504596],
  [45.824463, -122.504509],
  [45.824482, -122.50443300000002],
  [45.824504, -122.504347],
  [45.824515, -122.50426699999998],
  [45.824523, -122.50419299999999],
  [45.824529, -122.504103],
  [45.824536, -122.50384599999998],
  [45.824538, -122.503083],
  [45.824541, -122.501373],
  [45.824544, -122.500123],
  [45.824561, -122.49556699999998],
  [45.824784, -122.495573],
  [45.827316, -122.495573],
  [45.828142, -122.49557100000001],
  [45.830095, -122.495591],
  [45.831333, -122.495594],
  [45.831675, -122.495573],
  [45.831773, -122.495573],
  [45.831823, -122.49556899999999],
  [45.831903, -122.495558],
  [45.832032, -122.495533],
  [45.832131, -122.495514],
  [45.83232, -122.495464],
  [45.832447, -122.495424],
  [45.832581, -122.49538600000001],
  [45.832695, -122.495342],
  [45.832809, -122.49528899999999],
  [45.832929, -122.49521499999999],
  [45.833015, -122.49513400000001],
  [45.833203, -122.49492099999999],
  [45.833349, -122.494745],
  [45.833515, -122.494557],
  [45.833598, -122.494483],
  [45.833635, -122.49445],
  [45.833736, -122.49439799999999],
  [45.833828, -122.494358],
  [45.833945, -122.494327],
  [45.834048, -122.494308],
  [45.834435, -122.494298],
  [45.834547, -122.49431900000002],
  [45.83456, -122.494124],
  [45.834564, -122.49400700000001],
  [45.834555, -122.49386799999999],
  [45.834536, -122.493721],
  [45.834515, -122.493584],
  [45.834291, -122.492336],
  [45.834225, -122.491891],
  [45.834181, -122.49155199999998],
  [45.834147, -122.491193],
  [45.834109, -122.49073799999998],
  [45.83409, -122.49042499999999],
  [45.834063, -122.489948],
  [45.83404, -122.489538],
  [45.834033, -122.489246],
  [45.834037, -122.489055],
  [45.834048, -122.48888400000001],
  [45.834067, -122.488728],
  [45.834086, -122.48860199999999],
  [45.834116, -122.488471],
  [45.834153, -122.48833],
  [45.83421, -122.488129],
  [45.834276, -122.487909],
  [45.834408, -122.48747299999998],
  [45.834495, -122.48718300000002],
  [45.834544, -122.48698200000001],
  [45.834582, -122.486775],
  [45.834607, -122.486581],
  [45.834621, -122.486393],
  [45.834618, -122.486128],
  [45.834618, -122.48608],
  [45.834581, -122.48515],
  [45.834576, -122.484851],
  [45.834566, -122.48437699999998],
  [45.834561, -122.48392],
  [45.834567, -122.483721],
  [45.834584, -122.48353],
  [45.834606, -122.483328],
  [45.834636, -122.483126],
  [45.834678, -122.482836],
  [45.834777, -122.482249],
  [45.83484, -122.481857],
  [45.834888, -122.48153299999998],
  [45.834918, -122.48132700000001],
  [45.834976, -122.480958],
  [45.835017, -122.480731],
  [45.835095, -122.480296],
  [45.835233, -122.479562],
  [45.835259, -122.479394],
  [45.835275, -122.47925100000002],
  [45.83529, -122.47910500000002],
  [45.835307, -122.47888999999999],
  [45.835311, -122.478729],
  [45.835311, -122.478273],
  [45.835305, -122.477814],
  [45.835298, -122.476968],
  [45.835296, -122.476254],
  [45.835297, -122.475965],
  [45.835299, -122.475665],
  [45.835281, -122.474958],
  [45.835289, -122.474454],
  [45.835287, -122.47420000000001],
  [45.835284, -122.473677],
  [45.835284, -122.473613],
  [45.835296, -122.473333],
  [45.835313, -122.473139],
  [45.835364, -122.47266800000001],
  [45.835398, -122.472398],
  [45.835434, -122.47209199999999],
  [45.835463, -122.47184899999999],
  [45.835491, -122.47160399999999],
  [45.835528, -122.471362],
  [45.835564, -122.47116699999998],
  [45.835604, -122.470985],
  [45.835668, -122.470782],
  [45.83576, -122.470575],
  [45.835863, -122.47033599999999],
  [45.836027, -122.46995400000002],
  [45.836139, -122.469673],
  [45.836211, -122.46946599999998],
  [45.836263, -122.469295],
  [45.836318, -122.469103],
  [45.836379, -122.46881800000001],
  [45.836472, -122.468368],
  [45.83655, -122.468037],
  [45.836605, -122.467759],
  [45.836625, -122.467635],
  [45.836646, -122.467505],
  [45.836672, -122.467253],
  [45.83669, -122.467016],
  [45.836728, -122.46648],
  [45.836744, -122.466322],
  [45.836766, -122.46615000000001],
  [45.836802, -122.466011],
  [45.836837, -122.46589099999998],
  [45.836881, -122.465794],
  [45.837025, -122.46557600000001],
  [45.837272, -122.465238],
  [45.837767, -122.464573],
  [45.837953, -122.464282],
  [45.83808, -122.464071],
  [45.838348, -122.463589],
  [45.838549, -122.463245],
  [45.838665, -122.463034],
  [45.838738, -122.462883],
  [45.838818, -122.46271600000001],
  [45.839044, -122.462093],
  [45.839077, -122.462002],
  [45.839209, -122.461622],
  [45.839439, -122.46098799999999],
  [45.839701, -122.460239],
  [45.839956, -122.45949999999999],
  [45.840105, -122.45903000000001],
  [45.840208, -122.45873899999998],
  [45.840309, -122.458406],
  [45.84039, -122.45809999999999],
  [45.840428, -122.457926],
  [45.840479, -122.457681],
  [45.840516, -122.45743599999999],
  [45.840537, -122.45725],
  [45.840583, -122.45683199999999],
  [45.840608, -122.456563],
  [45.840627, -122.45628800000001],
  [45.840647, -122.45586000000002],
  [45.840661, -122.455482],
  [45.840669, -122.45499699999999],
  [45.840672, -122.454285],
  [45.840668, -122.453155],
  [45.840657, -122.452695],
  [45.840611, -122.451858],
  [45.84062, -122.451428],
  [45.840634, -122.451188],
  [45.840654, -122.450978],
  [45.840753, -122.450068],
  [45.840767, -122.449912],
  [45.840781, -122.449698],
  [45.840788, -122.44952699999999],
  [45.840789, -122.44935799999999],
  [45.84077, -122.44856400000002],
  [45.840755, -122.44786800000001],
  [45.840737, -122.446959],
  [45.840729, -122.44677100000001],
  [45.840715, -122.44661],
  [45.840695, -122.446428],
  [45.840664, -122.44624],
  [45.840623, -122.446037],
  [45.840581, -122.445835],
  [45.840542, -122.445659],
  [45.840503, -122.44547299999999],
  [45.840475, -122.445304],
  [45.840453, -122.44515],
  [45.840438, -122.44498299999998],
  [45.840428, -122.444776],
  [45.840421, -122.444566],
  [45.840426, -122.444343],
  [45.840435, -122.444128],
  [45.840452, -122.443917],
  [45.840477, -122.443714],
  [45.840522, -122.443398],
  [45.840533, -122.443292],
  [45.840659, -122.442441],
  [45.840761, -122.44170800000002],
  [45.840827, -122.441234],
  [45.840886, -122.440861],
  [45.840942, -122.440545],
  [45.840985, -122.44035200000002],
  [45.841187, -122.439574],
  [45.841239, -122.43932299999999],
  [45.841284, -122.43906600000001],
  [45.841325, -122.43879099999998],
  [45.841336, -122.43870500000001],
  [45.841358, -122.438524],
  [45.841394, -122.438246],
  [45.841417, -122.438014],
  [45.841426, -122.437883],
  [45.841424, -122.43779],
  [45.841425, -122.43777000000001],
  [45.841418, -122.43760399999998],
  [45.841407, -122.43742799999998],
  [45.841381, -122.43727500000001],
  [45.841344, -122.43712000000001],
  [45.841294, -122.43696],
  [45.841215, -122.43669899999999],
  [45.841148, -122.436455],
  [45.841089, -122.43629],
  [45.841039, -122.436092],
  [45.840995, -122.43588400000002],
  [45.840971, -122.435753],
  [45.840942, -122.435533],
  [45.840912, -122.435268],
  [45.840872, -122.43489],
  [45.840842, -122.434592],
  [45.840822, -122.434435],
  [45.840797, -122.434273],
  [45.84077, -122.43409599999998],
  [45.840742, -122.433932],
  [45.840705, -122.433734],
  [45.840663, -122.43354],
  [45.840617, -122.433363],
  [45.840576, -122.433243],
  [45.840536, -122.43313],
  [45.840471, -122.43297599999998],
  [45.840404, -122.432833],
  [45.840311, -122.43264500000001],
  [45.840211, -122.432449],
  [45.840113, -122.43226],
  [45.840004, -122.43206199999999],
  [45.839826, -122.43177000000001],
  [45.839768, -122.431668],
  [45.83972, -122.431579],
  [45.839674, -122.431486],
  [45.839637, -122.43139799999999],
  [45.8396, -122.431302],
  [45.839573, -122.43121700000002],
  [45.839544, -122.431109],
  [45.83952, -122.431018],
  [45.839499, -122.430912],
  [45.839478, -122.43079199999998],
  [45.839464, -122.430679],
  [45.839453, -122.430541],
  [45.839448, -122.43042],
  [45.839451, -122.43030800000001],
  [45.839458, -122.43018299999999],
  [45.839471, -122.43007],
  [45.839502, -122.429867],
  [45.839529, -122.42972000000002],
  [45.839621, -122.429285],
  [45.839769, -122.428569],
  [45.839785, -122.42849399999999],
  [45.839802, -122.42841],
  [45.839994, -122.42747],
  [45.840062, -122.427162],
  [45.840115, -122.426951],
  [45.840128, -122.426896],
  [45.840189, -122.426653],
  [45.840297, -122.42623300000001],
  [45.840403, -122.425853],
  [45.840559, -122.425337],
  [45.840721, -122.424811],
  [45.84081, -122.42450000000001],
  [45.840907, -122.424136],
  [45.840987, -122.423824],
  [45.84102, -122.42368500000002],
  [45.841049, -122.42355100000002],
  [45.841069, -122.42343599999998],
  [45.841084, -122.423332],
  [45.841093, -122.423229],
  [45.841096, -122.423113],
  [45.841095, -122.42300799999998],
  [45.841088, -122.42290300000002],
  [45.841077, -122.422803],
  [45.841058, -122.422682],
  [45.841032, -122.422576],
  [45.840999, -122.422455],
  [45.840892, -122.42209799999999],
  [45.840616, -122.421192],
  [45.840562, -122.42102899999999],
  [45.840508, -122.42088],
  [45.840447, -122.420736],
  [45.840382, -122.420587],
  [45.840319, -122.42045],
  [45.840232, -122.42029],
  [45.840155, -122.420151],
  [45.840066, -122.42],
  [45.839975, -122.419841],
  [45.839858, -122.41969],
  [45.839734, -122.41953000000001],
  [45.83966, -122.41943700000002],
  [45.839078, -122.418788],
  [45.838691, -122.41835900000001],
  [45.838078, -122.41768],
  [45.837951, -122.41753],
  [45.837866, -122.417435],
  [45.83778, -122.41732699999999],
  [45.837709, -122.41723200000001],
  [45.837612, -122.417096],
  [45.83753, -122.416961],
  [45.837432, -122.416783],
  [45.837326, -122.41658899999999],
  [45.837206, -122.41632799999998],
  [45.837086, -122.41603100000002],
  [45.836917, -122.41557099999999],
  [45.836671, -122.41490900000001],
  [45.836535, -122.41453200000001],
  [45.836354, -122.414044],
  [45.836062, -122.413263],
  [45.835763, -122.412452],
  [45.835568, -122.41193],
  [45.835327, -122.41131999999999],
  [45.835285, -122.411213],
  [45.83519, -122.41097300000001],
  [45.835103, -122.410752],
  [45.834681, -122.409688],
  [45.833407, -122.406499],
  [45.833356, -122.406374],
  [45.833313, -122.406266],
  [45.833266, -122.406136],
  [45.833218, -122.405985],
  [45.83318, -122.40586400000001],
  [45.833145, -122.405731],
  [45.833113, -122.40560500000001],
  [45.833087, -122.40548700000001],
  [45.833058, -122.40533400000001],
  [45.833031, -122.405173],
  [45.833007, -122.40502600000002],
  [45.832983, -122.404833],
  [45.832957, -122.404595],
  [45.832932, -122.40438500000002],
  [45.832906, -122.404128],
  [45.83289, -122.403962],
  [45.832869, -122.403713],
  [45.83284, -122.403431],
  [45.832815, -122.40321899999999],
  [45.832757, -122.402633],
  [45.832665, -122.40178699999998],
  [45.832608, -122.401275],
  [45.832575, -122.40103500000001],
  [45.832552, -122.400825],
  [45.832537, -122.400645],
  [45.832532, -122.400486],
  [45.832527, -122.400362],
  [45.832533, -122.400164],
  [45.832554, -122.399939],
  [45.832587, -122.399726],
  [45.83262, -122.399502],
  [45.832685, -122.399143],
  [45.832778, -122.39858000000001],
  [45.832899, -122.39787400000002],
  [45.833006, -122.397257],
  [45.833082, -122.396823],
  [45.83316, -122.396364],
  [45.833219, -122.396013],
  [45.833248, -122.395762],
  [45.833264, -122.395587],
  [45.83327, -122.395439],
  [45.833265, -122.395284],
  [45.833254, -122.395137],
  [45.833229, -122.394933],
  [45.833182, -122.394629],
  [45.833076, -122.394111],
  [45.832979, -122.393553],
  [45.832877, -122.392982],
  [45.832757, -122.39231399999998],
  [45.832692, -122.391954],
  [45.832662, -122.391779],
  [45.832596, -122.39146900000001],
  [45.832579, -122.391403],
  [45.83255, -122.39129599999998],
  [45.832519, -122.39120100000001],
  [45.8325, -122.391142],
  [45.832463, -122.391047],
  [45.832434, -122.390984],
  [45.832407, -122.390925],
  [45.832329, -122.390781],
  [45.832286, -122.390704],
  [45.832231, -122.390608],
  [45.832177, -122.390505],
  [45.832114, -122.39036099999998],
  [45.832053, -122.39020100000002],
  [45.831994, -122.390029],
  [45.831917, -122.389756],
  [45.831897, -122.38967399999999],
  [45.831871, -122.38954400000001],
  [45.831844, -122.389353],
  [45.831824, -122.389179],
  [45.831816, -122.389067],
  [45.831813, -122.388948],
  [45.831815, -122.38883800000002],
  [45.831821, -122.38871],
  [45.831836, -122.38856099999998],
  [45.831858, -122.388413],
  [45.831908, -122.388151],
  [45.832008, -122.38767899999999],
  [45.832087, -122.38728800000001],
  [45.832095, -122.387247],
  [45.832136, -122.38705400000002],
  [45.832218, -122.386662],
  [45.832241, -122.38655899999999],
  [45.832274, -122.38642900000002],
  [45.832317, -122.386297],
  [45.832383, -122.38615],
  [45.832433, -122.386045],
  [45.832491, -122.38593400000002],
  [45.832553, -122.385843],
  [45.832632, -122.385734],
  [45.8327, -122.385664],
  [45.832778, -122.38559199999999],
  [45.832857, -122.38553],
  [45.832958, -122.38547],
  [45.833069, -122.385412],
  [45.833144, -122.385382],
  [45.833214, -122.385355],
  [45.833313, -122.385322],
  [45.833447, -122.385283],
  [45.833508, -122.385264],
  [45.833685, -122.38521299999998],
  [45.833847, -122.385168],
  [45.834003, -122.38514300000001],
  [45.834156, -122.38512700000001],
  [45.834344, -122.385116],
  [45.834507, -122.385106],
  [45.83475, -122.385089],
  [45.834931, -122.38508300000001],
  [45.835039, -122.38508],
  [45.835158, -122.385084],
  [45.835274, -122.38508799999998],
  [45.83539, -122.385106],
  [45.835484, -122.385125],
  [45.835585, -122.38515200000002],
  [45.835695, -122.385188],
  [45.835817, -122.385232],
  [45.835914, -122.38527500000001],
  [45.835999, -122.38531200000001],
  [45.836076, -122.38534899999999],
  [45.836155, -122.385385],
  [45.836234, -122.385426],
  [45.83631, -122.38547],
  [45.836397, -122.38553],
  [45.83648, -122.38559199999999],
  [45.83654, -122.38564700000002],
  [45.83661, -122.385712],
  [45.83667, -122.38578],
  [45.836742, -122.385871],
  [45.836808, -122.38596000000001],
  [45.836858, -122.38603899999998],
  [45.836907, -122.386119],
  [45.836951, -122.386209],
  [45.83699, -122.38629099999999],
  [45.837026, -122.38637],
  [45.837061, -122.386444],
  [45.837089, -122.386509],
  [45.837131, -122.386606],
  [45.837251, -122.386882],
  [45.837358, -122.387127],
  [45.837415, -122.38724899999998],
  [45.837467, -122.38734600000001],
  [45.837531, -122.38746400000001],
  [45.837567, -122.387523],
  [45.837598, -122.387572],
  [45.837679, -122.387687],
  [45.837743, -122.38776700000001],
  [45.83786, -122.387908],
  [45.837999, -122.38805899999998],
  [45.838285, -122.388338],
  [45.838484, -122.388516],
  [45.838725, -122.388705],
  [45.83881, -122.388772],
  [45.838978, -122.38890099999999],
  [45.839391, -122.389223],
  [45.839766, -122.389502],
  [45.84006, -122.389699],
  [45.840641, -122.390087],
  [45.840987, -122.390313],
  [45.841382, -122.390579],
  [45.841686, -122.39078],
  [45.842113, -122.391059],
  [45.842546, -122.39134400000002],
  [45.842986, -122.391632],
  [45.843275, -122.39181899999998],
  [45.843596, -122.392033],
  [45.843882, -122.39222],
  [45.844127, -122.392382],
  [45.844389, -122.392555],
  [45.844689, -122.392757],
  [45.844884, -122.392882],
  [45.845083, -122.393009],
  [45.845242, -122.393111],
  [45.845323, -122.39316599999998],
  [45.845372, -122.393209],
  [45.845409, -122.393241],
  [45.845445, -122.393278],
  [45.845483, -122.393324],
  [45.84552, -122.393382],
  [45.845552, -122.393452],
  [45.845573, -122.39350799999998],
  [45.845587, -122.393565],
  [45.845622, -122.393714],
  [45.845638, -122.39377199999998],
  [45.845658, -122.393832],
  [45.845692, -122.393903],
  [45.845726, -122.39396399999998],
  [45.84577, -122.394027],
  [45.845822, -122.39408],
  [45.845876, -122.39412800000001],
  [45.845935, -122.39417200000001],
  [45.845991, -122.394213],
  [45.846055, -122.39425099999998],
  [45.846372, -122.394444],
  [45.847089, -122.394913],
  [45.847702, -122.39529399999999],
  [45.848781, -122.39601],
  [45.849354, -122.39636999999999],
  [45.849843, -122.396688],
  [45.850899, -122.397385],
  [45.852003, -122.398098],
  [45.852612, -122.398516],
  [45.852897, -122.39869099999999],
  [45.853292, -122.39894299999999],
  [45.85431, -122.399602],
  [45.854825, -122.399935],
  [45.855141, -122.400148],
  [45.855585, -122.400434],
  [45.856377, -122.40095100000002],
  [45.856888, -122.40129199999998],
  [45.857397, -122.40161800000001],
  [45.858393, -122.402265],
  [45.860324, -122.403526],
  [45.86195, -122.404583],
  [45.862277, -122.404794],
  [45.863177, -122.405379],
  [45.864099, -122.405969],
  [45.864973, -122.40655799999999],
  [45.865897, -122.407135],
  [45.866787, -122.40770800000001],
  [45.866795824231495, -122.40835081132545]
];

const stopNames = {
  "2382": "W Main &amp; 5th Ave",
  "9022": "Van Mall Transit Center: Bay C",
  "829": "E Main St &amp; Parkway",
  "828": "W Main St &amp; SW 3rd Ave",
  "827": "W Main St 800 Block",
  "2383": "E Main St 500 Block",
  "3741": "Yacolt Rd &amp; Railroad Ave",
  "831": "E Main &amp; SE Clark Ave",
  "6200": "NE Grace Ave &amp; E Main St"
};

const stops = [
  { stop_id: "9022", name: "Van Mall Transit Center: Bay C", lat: 45.656136, lon: -122.584653, times: ["11:50 AM", "5:50 PM", "5:15 AM"] },
  { stop_id: "827", name: "W Main St 800 Block", lat: 45.780651, lon: -122.545967, times: ["5:34 AM", "12:14 PM", "6:15 PM"] },
  { stop_id: "2382", name: "W Main &amp; 5th Ave", lat: 45.780689, lon: -122.542923, times: ["5:34 AM", "12:14 PM", "6:15 PM"] },
  { stop_id: "828", name: "W Main St &amp; SW 3rd Ave", lat: 45.780724, lon: -122.540004, times: ["5:35 AM", "12:15 PM", "6:16 PM"] },
  { stop_id: "829", name: "E Main St &amp; Parkway", lat: 45.780801, lon: -122.536742, times: ["5:36 AM", "12:16 PM", "6:17 PM"] },
  { stop_id: "2383", name: "E Main St 500 Block", lat: 45.780862, lon: -122.532162, times: ["5:37 AM", "12:17 PM", "6:18 PM"] },
  { stop_id: "831", name: "E Main &amp; SE Clark Ave", lat: 45.780906, lon: -122.529998, times: ["5:37 AM", "12:17 PM", "6:18 PM"] },
  { stop_id: "6200", name: "NE Grace Ave &amp; E Main St", lat: 45.781197, lon: -122.529097, times: ["5:38 AM", "12:18 PM", "6:19 PM"] },
  { stop_id: "3741", name: "Yacolt Rd &amp; Railroad Ave", lat: 45.86686, lon: -122.408349, times: ["6:04 AM", "12:44 PM", "6:45 PM"] },
]

    const polylineOut = L.polyline(shapeOutbound, { color: 'blue', weight: 4, opacity: 0.7 }).addTo(map);
    map.fitBounds(polylineOut.getBounds());

    const nowPT = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
    const nowMins = nowPT.getHours() * 60 + nowPT.getMinutes();

    stops.forEach(stop => {
      let highlightedTimes = [];
      let foundNext = false;
      stop.times.forEach(timeStr => {
        let cleanTime = timeStr.trim();
        let [h, m] = cleanTime.split(":");
        let schedMins = parseInt(h, 10) * 60 + parseInt(m, 10);
        if (schedMins < nowMins && nowMins - schedMins > 720) {
          schedMins += 1440;
        }
        if (!foundNext && schedMins >= nowMins) {
          highlightedTimes.push(`<span style="background:#4dd0e1; color:#000; padding:2px 6px; border-radius:6px; font-weight:bold;">${cleanTime}</span>`);
          foundNext = true;
        } else {
          highlightedTimes.push(cleanTime);
        }
      });

      L.circleMarker([stop.lat, stop.lon], {
        radius: 6,
        color: '#4dd0e1',
        fillColor: '#4dd0e1',
        fillOpacity: 0.9,
        weight: 1
      })
      .bindPopup(`<strong>${stop.name}</strong><br>${highlightedTimes.join("<br>") || 'No scheduled times'}`)
      .addTo(map);
    });

    let busMarkers = {};
    async function fetchAndDisplay() {
      const res = await fetch(`https://developer.trimet.org/ws/v2/vehicles?route=${routeNumber}&appID=${apiKey}&json=true`);
      const data = await res.json();
      const buses = (data.resultSet.vehicle || []).filter(v => v.routeNumber == routeNumber && v.direction == direction);

      Object.values(busMarkers).forEach(m => map.removeLayer(m));
      busMarkers = {};
      if (!buses.length) return;

      buses.forEach(bus => {
        if (!bus.latitude || !bus.longitude || !bus.blockID) return;
        const icon = L.divIcon({    
           className: '',
           html: `
            <div style="text-align:center;">
              <div style="background:#0071CE;color:#fff;padding:2px 6px;border-radius:6px;font-weight:bold;">${bus.vehicleID}</div>
              <div style="width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:10px solid #00bfff;margin:auto;"></div>
            </div>
          `,
          iconSize: [40, 30], iconAnchor: [20, 30]
        });
        const marker = L.marker([bus.latitude, bus.longitude], { icon }).addTo(map);
        busMarkers[bus.vehicleID] = marker;
      });
    }
    fetchAndDisplay();
    setInterval(fetchAndDisplay, 15000);
  </script>

  <footer class="site-footer">
    <a href="terms.html">Terms of Use</a> &nbsp;|&nbsp;
    <a href="contact.html">Contact Us</a> &nbsp;|&nbsp;
    <a href="report.html">Report a Problem</a> &nbsp;|&nbsp;
    <a href="dmca.html">DMCA</a> &nbsp;|&nbsp;
    <a href="privacy.html">Privacy Policy</a>
  </footer>

  <script>
    if (!localStorage.getItem('cookieConsent')) {
      document.write(`
        <div id="cookie-banner" style="position: fixed; bottom: 0; left: 0; right: 0; background: #333; color: #fff; padding: 1rem; z-index: 1000; font-size: 0.9rem; line-height: 1.4; text-align: center; box-sizing: border-box;">
          üì¢ We use cookies to improve functionality and analyze traffic.
          By using MetroFeed, you agree to our 
          <a href='privacy.html' style='color: #4dd0e1; text-decoration: underline;'>Privacy Policy</a>.<br>
          <button onclick='localStorage.setItem("cookieConsent", "true"); document.getElementById("cookie-banner").remove();' style='margin-top: 0.5rem; background: #4dd0e1; color: #000; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; font-weight: bold;'>OK</button>
        </div>
      `);
    }
  </script>
</body>
</html>