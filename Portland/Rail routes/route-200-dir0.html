<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EL337T4JX4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-EL337T4JX4');
</script>

<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Route 200 - To Clackamas Town Center | MetroFeed Portland</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  html, body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', sans-serif;
    background-color: #0d0d0d;
    color: #cccccc;
    overflow-y: auto;
  }

  .back-button-fixed {
    position: fixed;
    top: 20px;
    left: 20px;
    width: 45px;
    height: 45px;
    background-color: #4dd0e1;
    border: 2px solid #000;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1001;
    box-shadow: 0 0 10px #4dd0e1;
    cursor: pointer;
    transition: background 0.2s;
    outline: none;
  }
  .back-button-fixed:active, .back-button-fixed:focus {
    background-color: #1976d2;
  }
  .back-button-fixed svg {
    width: 24px;
    height: 24px;
    fill: #000;
    display: block;
  }
  .back-button-fixed:active svg,
  .back-button-fixed:focus svg {
    fill: #fff;
  }

  header {
    background-color: #0d0d0d;
    border-top: 4px solid #4dd0e1;
    border-bottom: 3px solid #4dd0e1;
    padding: 1rem;
    text-align: center;
  }

  header img {
    max-height: 60px;
  }

  h1#route-title {
    text-align: center;
    margin: 1rem 0;
    font-size: 2rem;
    color: #f0f0f0;
  }

  .content-box {
    border-radius: 12px;
    padding: 0;
    margin: 0;
    background-color: #1e1e1e;
  }

  #map {
    width: 100%;
    height: 85vh;
    border: none;
    margin: 0 auto;
    display: block;
    border-radius: 8px;
  }

  .button-bar {
    display: flex;
    justify-content: center;
    margin: 1rem 0;
  }

  .button-bar a, .back-button {
    background: #4dd0e1;
    color: #0d0d0d;
    padding: 0.6rem 1.2rem;
    text-decoration: none;
    border-radius: 8px;
    font-weight: bold;
    border: none;
    cursor: pointer;
    box-shadow: 0 0 10px #4dd0e1;
  }

  .back-button:hover {
    background-color: #35c0d6;
  }

  .site-footer {
    text-align: center;
    margin-top: 3rem;
    margin-bottom: 120px;
    font-size: 0.85rem;
    color: #aaa;
  }

  .site-footer a {
    color: #00BFFF;
    text-decoration: none;
  }

  .site-footer a:hover {
    text-decoration: underline;
  }

.favorite-save-box {
  position: absolute;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  z-index: 1010;
}

.favorite-star {
  background: #4dd0e1;
  color: #FFD700;
  font-size: 2.5rem;
  border: 2px solid #222;
  border-radius: 10px;
  width: 56px;
  height: 56px;
  cursor: pointer;
  box-shadow: 0 0 8px #4dd0e1;
  transition: background 0.18s, color 0.18s;
  display: flex;
  align-items: center;
  justify-content: center;
  outline: none;
  margin-bottom: 8px;
}
.favorite-star:active,
.favorite-star:focus {
  background: #1976d2;
  color: #ffea00;
}

.favorite-label {
  color: #4dd0e1;
  font-size: 1.03rem;
  font-weight: bold;
  background: #181818;
  border-radius: 6px;
  padding: 2px 10px;
  text-align: center;
  letter-spacing: 0.01em;
  margin-top: 0;
  box-shadow: 0 1px 6px #2224;
}
.fav-dropdown {
  display: none;
  position: absolute;
  top: 65px;
  right: 0;
  z-index: 99999;
  background: #222;
  border: 2px solid #4dd0e1;
  border-radius: 10px;
  padding: 10px 20px;
  text-align: center;
  box-shadow: 0 2px 12px #2224;
}
.fav-dropdown button {
  font-size: 1.1rem;
  padding: 6px 16px;
  background: #4dd0e1;
  color: #222;
  border: none;
  border-radius: 7px;
  cursor: pointer;
  font-weight: bold;
}
.fav-dropdown button:hover, .fav-dropdown button:focus {
  background: #fff;
  color: #0071ce;
  outline: none;
}
</style>
</head>
<body>
  
  <header>
    <img src="MetroFeedPortlandLogo.png" alt="MetroFeed Portland">
  </header>

<!-- Favorite Route Button (Top Right) with Dropdown -->
<div class="favorite-save-box">
  <button class="favorite-star" id="fav-star" aria-label="Save route to favorites" onclick="showFavDropdown(event)">☆</button>
  <div class="favorite-label">Save to Favorites</div>
  <div class="fav-dropdown" id="fav-dropdown">
    <button id="fav-dropdown-btn">Add to Favorites</button>
  </div>
</div>

  <!-- Beta Disclaimers -->
  <div class="disclaimer" style="margin: 1rem auto 0.5rem; max-width: 600px; font-size: 0.8rem; color: #bbb; text-align: center; padding: 0.5rem 1rem; background-color: #111; border: 1px dashed #444; border-radius: 6px;">
    ⚠️ This is a Beta program, work in progress. Please REPORT bugs and pretend to be impressed.
  </div>
  <div class="disclaimer" style="margin: 0 auto 1rem; max-width: 600px; font-size: 0.75rem; color: #888; text-align: center; padding: 0.25rem 1rem;">
    This tool is not affiliated with or endorsed by TriMet. For official schedules and service alerts, visit <a href="https://trimet.org" style="color:#4dd0e1;">trimet.org</a>.
  </div>

  <!-- Back button -->
  <button class="back-button-fixed" onclick="history.back()" aria-label="Go back">
    <svg viewBox="0 0 24 24">
      <path d="M15.5 19c-.28 0-.53-.11-.71-.29l-6.5-6.5a1.003 1.003 0 010-1.42l6.5-6.5a1.003 1.003 0 011.42 1.42L10.41 12l6.3 6.29a1.003 1.003 0 01-1.21 1.54z"/>
    </svg>
  </button>

  <h1 id="route-title">Route 200 - To Clackamas Town Center</h1>
  <span id="route-type" style="display:none;"></span>

  <div class="content-box">
    <div id="map"></div>
    <div style="text-align:right; font-size: 0.7rem; color: #777; margin-top: 0.5rem;">
      Data courtesy of TriMet.
    </div>
  </div>

  <script>
    if (document.referrer === "" && performance.navigation.type === 0) {
      window.location.href = "/index.html";
    }

    const apiKey = "2C4447D4A42083BCD84DE3B8E";
    const routeNumber = 200;
    const direction = parseInt(0);

    const map = L.map('map', {
      center: [45.6, -122.7],
      zoom: 12,
      minZoom: 12,
      maxZoom: 18,
      maxBounds: [[45.3, -123.1], [45.9, -122.3]],
      maxBoundsViscosity: 1.0
    });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    const shapeOutbound = [
  [45.508638, -122.683604],
  [45.508641, -122.683623],
  [45.50866, -122.683667],
  [45.508681, -122.683709],
  [45.508704, -122.683746],
  [45.508729, -122.683776],
  [45.508785, -122.683818],
  [45.508819, -122.683839],
  [45.508853, -122.683855],
  [45.50889, -122.683867],
  [45.508939, -122.683875],
  [45.508983, -122.683869],
  [45.509032, -122.68386],
  [45.509116, -122.683834],
  [45.509437, -122.683719],
  [45.509623, -122.683691],
  [45.509749, -122.683673],
  [45.510101, -122.683482],
  [45.510415, -122.683313],
  [45.510743, -122.683134],
  [45.510813, -122.683097],
  [45.511078, -122.682953],
  [45.511625, -122.682657],
  [45.511684, -122.682625],
  [45.511759, -122.682585],
  [45.512378, -122.682249],
  [45.512415, -122.682229],
  [45.51293, -122.68195],
  [45.512963, -122.681932],
  [45.513078, -122.68187],
  [45.513111, -122.681852],
  [45.513413, -122.681689],
  [45.513748, -122.681507],
  [45.514291, -122.681213],
  [45.514415, -122.681146],
  [45.515072, -122.68079],
  [45.515658, -122.680473],
  [45.515744, -122.680426],
  [45.515808, -122.680391],
  [45.516359, -122.680124],
  [45.516423, -122.680091],
  [45.516492, -122.680049],
  [45.517036, -122.679756],
  [45.517087, -122.67973],
  [45.517171, -122.679685],
  [45.517691, -122.679401],
  [45.51775, -122.679367],
  [45.517829, -122.679321],
  [45.518361, -122.679025],
  [45.518406, -122.679004],
  [45.518432, -122.678987],
  [45.518466, -122.67897],
  [45.519002, -122.678692],
  [45.519024, -122.67868],
  [45.51907, -122.678655],
  [45.519096, -122.678641],
  [45.519151, -122.678611],
  [45.519656, -122.678345],
  [45.519751, -122.678297],
  [45.519811, -122.678266],
  [45.520361, -122.677963],
  [45.520421, -122.677932],
  [45.520477, -122.677904],
  [45.521016, -122.677604],
  [45.521084, -122.677569],
  [45.521685, -122.677242],
  [45.521751, -122.677205],
  [45.521828, -122.677162],
  [45.522358, -122.67687],
  [45.522399, -122.676848],
  [45.522446, -122.676775],
  [45.522939, -122.676511],
  [45.523003, -122.676486],
  [45.523068, -122.676468],
  [45.523122, -122.676459],
  [45.52319, -122.676451],
  [45.523722, -122.676473],
  [45.523777, -122.676474],
  [45.523839, -122.676474],
  [45.524404, -122.676494],
  [45.524491, -122.676497],
  [45.525135, -122.676527],
  [45.525203, -122.676534],
  [45.525274, -122.676541],
  [45.525858, -122.67656],
  [45.525911, -122.676558],
  [45.525976, -122.676556],
  [45.526561, -122.676573],
  [45.526631, -122.676576],
  [45.5267, -122.676553],
  [45.52722, -122.67657],
  [45.527287, -122.676572],
  [45.52734, -122.676575],
  [45.527398, -122.676578],
  [45.527824, -122.676593],
  [45.527871, -122.676593],
  [45.527893, -122.676591],
  [45.527916, -122.676585],
  [45.52794, -122.676574],
  [45.527969, -122.676557],
  [45.52799, -122.676538],
  [45.52801, -122.676518],
  [45.528027, -122.676494],
  [45.528044, -122.676462],
  [45.528057, -122.676446],
  [45.528068, -122.676416],
  [45.528078, -122.676376],
  [45.528085, -122.676343],
  [45.528088, -122.676311],
  [45.52809, -122.676264],
  [45.528101, -122.675678],
  [45.528103, -122.675599],
  [45.528102, -122.675568],
  [45.528097, -122.675526],
  [45.528087, -122.675482],
  [45.528074, -122.675448],
  [45.528056, -122.675407],
  [45.527985, -122.675275],
  [45.527766, -122.674898],
  [45.52774, -122.674849],
  [45.527722, -122.674807],
  [45.527647, -122.674619],
  [45.527611, -122.674524],
  [45.527581, -122.674436],
  [45.527552, -122.674319],
  [45.527526, -122.674241],
  [45.527437, -122.674015],
  [45.527404, -122.67392],
  [45.527383, -122.673843],
  [45.527363, -122.673765],
  [45.527348, -122.673722],
  [45.527333, -122.673686],
  [45.527315, -122.673654],
  [45.527294, -122.673621],
  [45.527265, -122.673587],
  [45.527246, -122.673572],
  [45.527227, -122.67356],
  [45.527201, -122.673549],
  [45.527169, -122.67354],
  [45.52714, -122.673537],
  [45.527106, -122.673537],
  [45.527025, -122.673539],
  [45.52699, -122.673534],
  [45.526954, -122.673521],
  [45.526943, -122.673516],
  [45.526913, -122.673499],
  [45.526861, -122.673456],
  [45.526834, -122.673421],
  [45.526817, -122.673392],
  [45.526799, -122.673353],
  [45.526787, -122.673313],
  [45.526785, -122.673304],
  [45.526777, -122.67327],
  [45.52677, -122.67323],
  [45.526767, -122.673197],
  [45.526766, -122.67316],
  [45.526766, -122.673105],
  [45.526773, -122.672898],
  [45.526787, -122.672653],
  [45.526798, -122.672493],
  [45.526798, -122.672387],
  [45.526799, -122.672341],
  [45.526792, -122.672131],
  [45.526765, -122.671319],
  [45.526759, -122.671093],
  [45.52676, -122.671019],
  [45.526762, -122.670979],
  [45.526767, -122.670929],
  [45.526776, -122.670864],
  [45.52679, -122.670813],
  [45.526806, -122.670762],
  [45.526826, -122.670711],
  [45.526873, -122.670622],
  [45.526897, -122.670584],
  [45.526909, -122.670559],
  [45.526992, -122.670389],
  [45.527383, -122.669522],
  [45.527705, -122.668807],
  [45.527988, -122.66818],
  [45.528121, -122.667888],
  [45.52817, -122.667787],
  [45.528228, -122.667675],
  [45.52828, -122.667582],
  [45.52834, -122.667489],
  [45.528401, -122.667407],
  [45.52851, -122.667282],
  [45.528567, -122.667225],
  [45.528626, -122.667172],
  [45.52868, -122.66713],
  [45.528731, -122.667094],
  [45.528789, -122.667054],
  [45.528869, -122.66701],
  [45.528988, -122.666953],
  [45.529117, -122.666899],
  [45.529268, -122.666849],
  [45.529477, -122.666758],
  [45.529514, -122.666734],
  [45.529547, -122.666718],
  [45.529578, -122.666694],
  [45.529613, -122.666667],
  [45.529652, -122.666635],
  [45.529692, -122.666593],
  [45.529721, -122.666566],
  [45.529752, -122.66653],
  [45.529816, -122.666439],
  [45.529904, -122.66632],
  [45.529949, -122.66625],
  [45.530011, -122.66615],
  [45.530029, -122.666115],
  [45.530048, -122.666065],
  [45.530065, -122.66601],
  [45.530077, -122.665955],
  [45.530084, -122.665909],
  [45.530088, -122.665851],
  [45.530091, -122.665787],
  [45.530089, -122.665732],
  [45.530087, -122.665669],
  [45.530086, -122.664916],
  [45.530086, -122.664876],
  [45.530085, -122.664729],
  [45.530084, -122.664633],
  [45.530082, -122.663921],
  [45.530081, -122.663827],
  [45.53008, -122.663719],
  [45.530079, -122.663619],
  [45.530077, -122.662736],
  [45.530074, -122.661978],
  [45.530074, -122.661908],
  [45.530073, -122.661681],
  [45.530073, -122.661554],
  [45.530076, -122.660795],
  [45.530076, -122.660669],
  [45.530076, -122.660605],
  [45.530073, -122.659671],
  [45.53007, -122.658784],
  [45.530075, -122.658659],
  [45.530076, -122.658623],
  [45.530081, -122.658479],
  [45.530079, -122.657767],
  [45.530079, -122.657739],
  [45.530076, -122.657622],
  [45.530068, -122.657118],
  [45.530064, -122.656797],
  [45.530063, -122.656598],
  [45.530062, -122.656442],
  [45.530059, -122.655653],
  [45.530051, -122.654861],
  [45.53005, -122.654736],
  [45.530051, -122.654581],
  [45.530051, -122.654449],
  [45.530049, -122.653638],
  [45.530049, -122.653589],
  [45.530049, -122.653534],
  [45.530053, -122.653236],
  [45.530055, -122.652693],
  [45.530055, -122.652557],
  [45.530054, -122.652539],
  [45.530056, -122.652348],
  [45.530056, -122.652339],
  [45.530057, -122.652284],
  [45.530056, -122.652089],
  [45.530061, -122.651564],
  [45.53006, -122.651318],
  [45.530052, -122.651025],
  [45.530047, -122.650837],
  [45.530042, -122.650709],
  [45.530031, -122.650441],
  [45.530007, -122.649963],
  [45.529997, -122.649673],
  [45.529992, -122.649556],
  [45.529989, -122.649392],
  [45.529988, -122.649128],
  [45.529991, -122.648974],
  [45.530002, -122.648665],
  [45.53013, -122.645885],
  [45.530163, -122.645214],
  [45.530264, -122.643002],
  [45.530372, -122.640667],
  [45.530409, -122.639901],
  [45.530435, -122.639327],
  [45.530522, -122.637623],
  [45.530552, -122.637004],
  [45.530568, -122.636748],
  [45.530589, -122.636488],
  [45.5306, -122.636382],
  [45.53061, -122.636296],
  [45.530621, -122.636207],
  [45.530637, -122.6361],
  [45.530653, -122.635996],
  [45.530675, -122.635883],
  [45.530691, -122.635806],
  [45.53071, -122.635718],
  [45.530728, -122.63564],
  [45.530751, -122.635561],
  [45.530771, -122.635482],
  [45.530797, -122.635395],
  [45.530837, -122.635266],
  [45.530887, -122.635126],
  [45.530914, -122.635055],
  [45.530946, -122.634975],
  [45.530988, -122.634874],
  [45.531037, -122.634767],
  [45.531073, -122.634695],
  [45.531111, -122.634618],
  [45.531157, -122.634534],
  [45.5312, -122.634457],
  [45.531243, -122.634385],
  [45.531287, -122.634314],
  [45.531334, -122.634243],
  [45.531384, -122.634171],
  [45.531453, -122.634077],
  [45.531532, -122.633977],
  [45.531614, -122.633882],
  [45.531659, -122.633831],
  [45.531703, -122.633785],
  [45.531762, -122.633725],
  [45.531824, -122.633664],
  [45.531892, -122.633599],
  [45.531946, -122.633549],
  [45.532204, -122.633327],
  [45.532796, -122.632823],
  [45.53309, -122.632574],
  [45.533382, -122.632319],
  [45.533468, -122.63224],
  [45.533531, -122.63218],
  [45.533578, -122.632131],
  [45.533641, -122.632065],
  [45.533686, -122.632016],
  [45.533774, -122.631913],
  [45.533812, -122.631863],
  [45.533855, -122.631807],
  [45.533921, -122.631716],
  [45.533984, -122.631617],
  [45.534045, -122.631515],
  [45.534104, -122.631412],
  [45.534143, -122.631339],
  [45.534191, -122.631242],
  [45.534228, -122.631163],
  [45.534255, -122.631098],
  [45.534319, -122.630941],
  [45.534352, -122.630852],
  [45.53438, -122.630766],
  [45.534458, -122.630483],
  [45.534505, -122.630282],
  [45.534529, -122.630159],
  [45.534543, -122.630071],
  [45.534559, -122.629966],
  [45.534568, -122.629876],
  [45.534578, -122.629778],
  [45.534585, -122.629683],
  [45.534592, -122.629582],
  [45.534595, -122.629502],
  [45.534598, -122.629412],
  [45.534599, -122.62934],
  [45.534594, -122.629171],
  [45.534592, -122.629096],
  [45.534587, -122.629017],
  [45.534573, -122.628856],
  [45.534557, -122.62871],
  [45.534524, -122.628477],
  [45.534482, -122.628248],
  [45.533789, -122.625178],
  [45.533324, -122.623143],
  [45.532948, -122.621531],
  [45.53276, -122.620716],
  [45.532758, -122.620706],
  [45.532696, -122.620456],
  [45.532647, -122.620233],
  [45.532639, -122.620197],
  [45.532535, -122.61976],
  [45.532443, -122.619366],
  [45.532228, -122.618462],
  [45.532086, -122.617882],
  [45.532051, -122.617745],
  [45.532006, -122.617585],
  [45.531936, -122.617363],
  [45.531872, -122.617175],
  [45.531784, -122.616937],
  [45.531735, -122.616815],
  [45.531696, -122.616724],
  [45.531655, -122.61663],
  [45.531615, -122.616541],
  [45.531569, -122.616447],
  [45.531491, -122.616295],
  [45.531437, -122.616196],
  [45.53138, -122.616094],
  [45.531296, -122.615955],
  [45.53121, -122.615817],
  [45.531102, -122.615651],
  [45.53099, -122.615483],
  [45.530743, -122.615121],
  [45.530577, -122.614884],
  [45.530114, -122.614197],
  [45.529624, -122.613481],
  [45.529164, -122.612823],
  [45.528703, -122.61212],
  [45.528591, -122.61194],
  [45.528496, -122.611775],
  [45.528408, -122.611614],
  [45.528317, -122.611434],
  [45.528236, -122.611259],
  [45.528196, -122.61117],
  [45.528155, -122.611075],
  [45.528118, -122.610983],
  [45.528078, -122.61088],
  [45.528042, -122.610785],
  [45.528008, -122.61069],
  [45.527943, -122.610498],
  [45.52791, -122.610392],
  [45.527853, -122.610192],
  [45.527826, -122.610091],
  [45.527799, -122.609985],
  [45.527774, -122.609887],
  [45.52775, -122.609777],
  [45.527726, -122.609667],
  [45.527703, -122.609551],
  [45.527663, -122.609324],
  [45.527645, -122.609206],
  [45.527625, -122.609079],
  [45.527613, -122.608968],
  [45.527591, -122.608766],
  [45.527577, -122.608606],
  [45.527568, -122.60847],
  [45.527562, -122.608324],
  [45.527556, -122.608167],
  [45.527553, -122.608017],
  [45.527552, -122.60779],
  [45.527553, -122.607634],
  [45.527557, -122.607476],
  [45.527562, -122.60735],
  [45.527569, -122.607219],
  [45.527575, -122.607091],
  [45.527595, -122.606838],
  [45.527607, -122.606702],
  [45.527635, -122.606442],
  [45.527663, -122.606221],
  [45.527682, -122.606081],
  [45.527708, -122.605917],
  [45.527737, -122.605762],
  [45.5278, -122.60544],
  [45.527836, -122.605277],
  [45.527875, -122.60511],
  [45.527954, -122.604799],
  [45.528015, -122.604567],
  [45.528047, -122.604455],
  [45.528097, -122.604287],
  [45.528151, -122.60412],
  [45.528208, -122.603933],
  [45.528276, -122.603743],
  [45.528333, -122.603596],
  [45.528411, -122.603406],
  [45.528451, -122.603311],
  [45.528522, -122.603151],
  [45.528698, -122.602803],
  [45.528757, -122.602693],
  [45.528956, -122.602327],
  [45.529099, -122.602066],
  [45.529364, -122.601568],
  [45.529576, -122.601204],
  [45.530046, -122.600329],
  [45.530264, -122.599913],
  [45.530483, -122.599488],
  [45.530921, -122.598642],
  [45.532205, -122.596156],
  [45.532862, -122.594877],
  [45.533299, -122.594034],
  [45.533426, -122.593784],
  [45.533557, -122.593533],
  [45.534027, -122.592619],
  [45.534603, -122.591504],
  [45.534693, -122.591327],
  [45.534924, -122.590863],
  [45.534981, -122.590741],
  [45.535037, -122.590615],
  [45.535095, -122.590482],
  [45.535157, -122.590327],
  [45.535205, -122.590204],
  [45.535254, -122.590074],
  [45.535299, -122.589944],
  [45.535342, -122.589817],
  [45.535387, -122.589675],
  [45.535449, -122.589462],
  [45.535508, -122.589243],
  [45.535548, -122.589079],
  [45.535592, -122.588891],
  [45.535626, -122.588722],
  [45.535669, -122.588486],
  [45.535718, -122.588175],
  [45.535732, -122.588066],
  [45.535747, -122.587944],
  [45.535761, -122.58782],
  [45.535773, -122.587695],
  [45.535783, -122.587585],
  [45.535792, -122.587454],
  [45.5358, -122.587324],
  [45.535811, -122.587101],
  [45.535814, -122.586873],
  [45.535815, -122.586755],
  [45.535812, -122.586502],
  [45.535809, -122.586375],
  [45.535804, -122.586263],
  [45.535797, -122.58613],
  [45.535789, -122.586013],
  [45.535777, -122.585873],
  [45.535767, -122.585758],
  [45.535753, -122.585626],
  [45.535738, -122.585495],
  [45.535721, -122.585368],
  [45.535705, -122.585256],
  [45.535686, -122.585136],
  [45.535668, -122.585032],
  [45.535648, -122.584919],
  [45.535625, -122.584798],
  [45.535598, -122.584662],
  [45.535576, -122.584562],
  [45.535539, -122.584402],
  [45.535522, -122.584333],
  [45.535488, -122.584201],
  [45.535452, -122.584068],
  [45.535425, -122.583974],
  [45.535401, -122.583895],
  [45.53537, -122.583792],
  [45.535319, -122.583631],
  [45.535252, -122.583428],
  [45.534905, -122.582439],
  [45.534801, -122.582147],
  [45.534395, -122.58099],
  [45.534288, -122.580695],
  [45.534262, -122.58062],
  [45.534222, -122.580514],
  [45.534177, -122.580393],
  [45.534128, -122.58027],
  [45.534008, -122.579983],
  [45.533846, -122.579594],
  [45.533775, -122.579415],
  [45.533708, -122.579244],
  [45.533529, -122.578771],
  [45.533451, -122.578532],
  [45.533243, -122.577922],
  [45.533204, -122.577808],
  [45.533088, -122.577476],
  [45.532944, -122.577043],
  [45.532808, -122.576616],
  [45.532717, -122.576345],
  [45.532621, -122.576059],
  [45.532446, -122.57554],
  [45.532359, -122.575278],
  [45.532279, -122.575015],
  [45.532195, -122.574712],
  [45.532149, -122.57453],
  [45.532103, -122.574347],
  [45.532047, -122.574096],
  [45.53199, -122.573813],
  [45.531944, -122.573555],
  [45.5319, -122.573286],
  [45.531863, -122.573027],
  [45.53183, -122.572736],
  [45.531805, -122.572476],
  [45.531781, -122.572191],
  [45.531767, -122.57196],
  [45.531754, -122.571685],
  [45.531749, -122.571395],
  [45.531748, -122.571097],
  [45.531754, -122.570825],
  [45.531759, -122.570688],
  [45.531765, -122.570547],
  [45.531777, -122.570346],
  [45.531786, -122.57021],
  [45.531798, -122.570073],
  [45.531817, -122.569854],
  [45.53185, -122.569559],
  [45.531901, -122.5692],
  [45.532008, -122.568515],
  [45.532058, -122.568176],
  [45.532109, -122.567813],
  [45.532129, -122.567633],
  [45.532164, -122.567247],
  [45.532176, -122.566986],
  [45.532178, -122.566681],
  [45.532173, -122.566478],
  [45.532163, -122.566296],
  [45.532143, -122.566046],
  [45.532091, -122.565647],
  [45.532047, -122.565399],
  [45.532, -122.565178],
  [45.531932, -122.564905],
  [45.531835, -122.56458],
  [45.531779, -122.564419],
  [45.531711, -122.564263],
  [45.531623, -122.564128],
  [45.531506, -122.564032],
  [45.53137, -122.563975],
  [45.531154, -122.563897],
  [45.530996, -122.563838],
  [45.530894, -122.563802],
  [45.530606, -122.563693],
  [45.530341, -122.563591],
  [45.530275, -122.563565],
  [45.530273, -122.563564],
  [45.530242, -122.563554],
  [45.530178, -122.56353],
  [45.53012, -122.563514],
  [45.530043, -122.563499],
  [45.529995, -122.563493],
  [45.52996, -122.563489],
  [45.529916, -122.563486],
  [45.529822, -122.56349],
  [45.529783, -122.563494],
  [45.529735, -122.563501],
  [45.529648, -122.563522],
  [45.529608, -122.563535],
  [45.529567, -122.563548],
  [45.529515, -122.563566],
  [45.529473, -122.563582],
  [45.528969, -122.56375],
  [45.528907, -122.563773],
  [45.528563, -122.563891],
  [45.528493, -122.563913],
  [45.528432, -122.56393],
  [45.528371, -122.563944],
  [45.528313, -122.563955],
  [45.528246, -122.563966],
  [45.528186, -122.563975],
  [45.528067, -122.563986],
  [45.527823, -122.564005],
  [45.527497, -122.564031],
  [45.526475, -122.564112],
  [45.52618, -122.564137],
  [45.525924, -122.564156],
  [45.525797, -122.564165],
  [45.525512, -122.564206],
  [45.525435, -122.564219],
  [45.524591, -122.564364],
  [45.523972, -122.564475],
  [45.523363, -122.564578],
  [45.523141, -122.564611],
  [45.522924, -122.564636],
  [45.522807, -122.564646],
  [45.522586, -122.564663],
  [45.522271, -122.564675],
  [45.521993, -122.564676],
  [45.521854, -122.564672],
  [45.521719, -122.564666],
  [45.52144, -122.564648],
  [45.521303, -122.564634],
  [45.521161, -122.564619],
  [45.52097, -122.564593],
  [45.520782, -122.564563],
  [45.520408, -122.5645],
  [45.520212, -122.564469],
  [45.520117, -122.564458],
  [45.520021, -122.564448],
  [45.519921, -122.564441],
  [45.519819, -122.564436],
  [45.519618, -122.564431],
  [45.51943, -122.56443],
  [45.519252, -122.564433],
  [45.518913, -122.564439],
  [45.518417, -122.564447],
  [45.518218, -122.564449],
  [45.517784, -122.564456],
  [45.516942, -122.564465],
  [45.516565, -122.56447],
  [45.515759, -122.564463],
  [45.514959, -122.564481],
  [45.514631, -122.564489],
  [45.513988, -122.5645],
  [45.513931, -122.564501],
  [45.513592, -122.564507],
  [45.513504, -122.564509],
  [45.513413, -122.564513],
  [45.513343, -122.564518],
  [45.513275, -122.564527],
  [45.513179, -122.56454],
  [45.513107, -122.564555],
  [45.513005, -122.564579],
  [45.512881, -122.564613],
  [45.512203, -122.564826],
  [45.511933, -122.56491],
  [45.511824, -122.564942],
  [45.511718, -122.56497],
  [45.511523, -122.565013],
  [45.51142, -122.565031],
  [45.511326, -122.565044],
  [45.511146, -122.565058],
  [45.511053, -122.565059],
  [45.510966, -122.565059],
  [45.510767, -122.565048],
  [45.510684, -122.56504],
  [45.510605, -122.565029],
  [45.510531, -122.565017],
  [45.510453, -122.565002],
  [45.510294, -122.564965],
  [45.510142, -122.564926],
  [45.509526, -122.564776],
  [45.509417, -122.564752],
  [45.509303, -122.564734],
  [45.509187, -122.564721],
  [45.509077, -122.564716],
  [45.509015, -122.564715],
  [45.508953, -122.564718],
  [45.508837, -122.564726],
  [45.508778, -122.564734],
  [45.508721, -122.564742],
  [45.508662, -122.564752],
  [45.508605, -122.564765],
  [45.508519, -122.564786],
  [45.508436, -122.564811],
  [45.508346, -122.564842],
  [45.508264, -122.564875],
  [45.50816, -122.564921],
  [45.508037, -122.564985],
  [45.507977, -122.565019],
  [45.507903, -122.565065],
  [45.507808, -122.565133],
  [45.50773, -122.565198],
  [45.507602, -122.565312],
  [45.506937, -122.565934],
  [45.506906, -122.565964],
  [45.506827, -122.566031],
  [45.506695, -122.566134],
  [45.506628, -122.56618],
  [45.506571, -122.566216],
  [45.506496, -122.56626],
  [45.506416, -122.566302],
  [45.506341, -122.566337],
  [45.506259, -122.56637],
  [45.50618, -122.566399],
  [45.506107, -122.566423],
  [45.506032, -122.566441],
  [45.505958, -122.566457],
  [45.50589, -122.56647],
  [45.505835, -122.566476],
  [45.505682, -122.566493],
  [45.504605, -122.566568],
  [45.504354, -122.566597],
  [45.504183, -122.566624],
  [45.504103, -122.566635],
  [45.50402, -122.566645],
  [45.503742, -122.566668],
  [45.503222, -122.566703],
  [45.503124, -122.566709],
  [45.50304, -122.566715],
  [45.502764, -122.566735],
  [45.502483, -122.56675],
  [45.5021, -122.566762],
  [45.501715, -122.566761],
  [45.501415, -122.566749],
  [45.501116, -122.566732],
  [45.500817, -122.566705],
  [45.500521, -122.566672],
  [45.499616, -122.566553],
  [45.49947, -122.566536],
  [45.499314, -122.566518],
  [45.499174, -122.566506],
  [45.499022, -122.566495],
  [45.498875, -122.566488],
  [45.498723, -122.566483],
  [45.498172, -122.566479],
  [45.497906, -122.566476],
  [45.49764, -122.56647],
  [45.497198, -122.566442],
  [45.497047, -122.566429],
  [45.496877, -122.566411],
  [45.496662, -122.566386],
  [45.496447, -122.566357],
  [45.496282, -122.566332],
  [45.496078, -122.566286],
  [45.495552, -122.566211],
  [45.4955, -122.566202],
  [45.495379, -122.566181],
  [45.49528, -122.566169],
  [45.494481, -122.566051],
  [45.494372, -122.566038],
  [45.494277, -122.566026],
  [45.494184, -122.566014],
  [45.49411, -122.56601],
  [45.494002, -122.566001],
  [45.493886, -122.566001],
  [45.49374, -122.566004],
  [45.493596, -122.566009],
  [45.493452, -122.566019],
  [45.493301, -122.566037],
  [45.493184, -122.566052],
  [45.492981, -122.56607],
  [45.4928, -122.56609],
  [45.492455, -122.566143],
  [45.492161, -122.56619],
  [45.49206, -122.566207],
  [45.491877, -122.566236],
  [45.491776, -122.56625],
  [45.491679, -122.566262],
  [45.490903, -122.56635],
  [45.490871, -122.566354],
  [45.490768, -122.566367],
  [45.490422, -122.566386],
  [45.490132, -122.566389],
  [45.489868, -122.566405],
  [45.48905, -122.566502],
  [45.488676, -122.566535],
  [45.488304, -122.566562],
  [45.487928, -122.566583],
  [45.487556, -122.566599],
  [45.487155, -122.566612],
  [45.48676, -122.566616],
  [45.486362, -122.566616],
  [45.485961, -122.566611],
  [45.485666, -122.566602],
  [45.48482, -122.566578],
  [45.484378, -122.566565],
  [45.484286, -122.566564],
  [45.484192, -122.566565],
  [45.484008, -122.566571],
  [45.483266, -122.566607],
  [45.482903, -122.566626],
  [45.482618, -122.566641],
  [45.481774, -122.566682],
  [45.481483, -122.566682],
  [45.481371, -122.56669],
  [45.481266, -122.566699],
  [45.481134, -122.566722],
  [45.480852, -122.566775],
  [45.48022, -122.566902],
  [45.480189, -122.566904],
  [45.480148, -122.566906],
  [45.480011, -122.566925],
  [45.479914, -122.566937],
  [45.4798, -122.566943],
  [45.479653, -122.566958],
  [45.479494, -122.566972],
  [45.479348, -122.566983],
  [45.479221, -122.566989],
  [45.47909, -122.566993],
  [45.478962, -122.566994],
  [45.478812, -122.566989],
  [45.478525, -122.566966],
  [45.478385, -122.566946],
  [45.478256, -122.566927],
  [45.478093, -122.566898],
  [45.477916, -122.566859],
  [45.477747, -122.566814],
  [45.47758, -122.566768],
  [45.477241, -122.566687],
  [45.476907, -122.566592],
  [45.476807, -122.566565],
  [45.476699, -122.566538],
  [45.476601, -122.566514],
  [45.476389, -122.56647],
  [45.476231, -122.566444],
  [45.476184, -122.566436],
  [45.475981, -122.566408],
  [45.475281, -122.566325],
  [45.474471, -122.566229],
  [45.473665, -122.566135],
  [45.473469, -122.566117],
  [45.473272, -122.566103],
  [45.472875, -122.566087],
  [45.472481, -122.566083],
  [45.472266, -122.566079],
  [45.471648, -122.566066],
  [45.471366, -122.566059],
  [45.471084, -122.566055],
  [45.470947, -122.566058],
  [45.470815, -122.566061],
  [45.469997, -122.566088],
  [45.469833, -122.566093],
  [45.469724, -122.5661],
  [45.469607, -122.566107],
  [45.469483, -122.566123],
  [45.469364, -122.566143],
  [45.46925, -122.566168],
  [45.469182, -122.566183],
  [45.469117, -122.566202],
  [45.469057, -122.566219],
  [45.468996, -122.56624],
  [45.468809, -122.566291],
  [45.468492, -122.566424],
  [45.468374, -122.56647],
  [45.468318, -122.566495],
  [45.468245, -122.566526],
  [45.467686, -122.566768],
  [45.467608, -122.566796],
  [45.467513, -122.566832],
  [45.467381, -122.566892],
  [45.467236, -122.566961],
  [45.467111, -122.567039],
  [45.466999, -122.567106],
  [45.466125, -122.567781],
  [45.465698, -122.568115],
  [45.465375, -122.568389],
  [45.465288, -122.568464],
  [45.465107, -122.568629],
  [45.464929, -122.568795],
  [45.464755, -122.568964],
  [45.464582, -122.569133],
  [45.464384, -122.569338],
  [45.463882, -122.569874],
  [45.463503, -122.570276],
  [45.46338, -122.570401],
  [45.463198, -122.570574],
  [45.463128, -122.570637],
  [45.463017, -122.570736],
  [45.462917, -122.57082],
  [45.462815, -122.570903],
  [45.462643, -122.571038],
  [45.46247, -122.571164],
  [45.462185, -122.571365],
  [45.46186, -122.571533],
  [45.46168, -122.57166],
  [45.46141, -122.571912],
  [45.461122, -122.572114],
  [45.460747, -122.572375],
  [45.46056, -122.572506],
  [45.460376, -122.572632],
  [45.460128, -122.572786],
  [45.459879, -122.572927],
  [45.459753, -122.572991],
  [45.459631, -122.573052],
  [45.459052, -122.573326],
  [45.458659, -122.57351],
  [45.458418, -122.573625],
  [45.458037, -122.573804],
  [45.457899, -122.573865],
  [45.457757, -122.573924],
  [45.457622, -122.573973],
  [45.457482, -122.574017],
  [45.457345, -122.574051],
  [45.457206, -122.574079],
  [45.457071, -122.574101],
  [45.45693, -122.574114],
  [45.45686, -122.574118],
  [45.456797, -122.57412],
  [45.456659, -122.57412],
  [45.456526, -122.574115],
  [45.456362, -122.574099],
  [45.456284, -122.574089],
  [45.456208, -122.574078],
  [45.456051, -122.574054],
  [45.455901, -122.574029],
  [45.455282, -122.573934],
  [45.454887, -122.57387],
  [45.454502, -122.573818],
  [45.45421, -122.57379],
  [45.453973, -122.57377],
  [45.453718, -122.573741],
  [45.453545, -122.573715],
  [45.453386, -122.573682],
  [45.453134, -122.573619],
  [45.453121, -122.573615],
  [45.453024, -122.573585],
  [45.452575, -122.573429],
  [45.452124, -122.573262],
  [45.451811, -122.573152],
  [45.451505, -122.573049],
  [45.451294, -122.572984],
  [45.450906, -122.57286],
  [45.450363, -122.572677],
  [45.449578, -122.572404],
  [45.449013, -122.572207],
  [45.448445, -122.57201],
  [45.447031, -122.571518],
  [45.444969, -122.570797],
  [45.441936, -122.569747],
  [45.44109, -122.569452],
  [45.440923, -122.569396],
  [45.440744, -122.569337],
  [45.440573, -122.569285],
  [45.440398, -122.569234],
  [45.440001, -122.56913],
  [45.439597, -122.569028],
  [45.439301, -122.56895],
  [45.439008, -122.568867],
  [45.438723, -122.568774],
  [45.438444, -122.568681],
  [45.437983, -122.568519],
  [45.437546, -122.56837],
  [45.43702, -122.568187],
  [45.436746, -122.568093],
  [45.436563, -122.568031],
  [45.436394, -122.567988],
  [45.436079, -122.567911],
  [45.435653, -122.567806],
  [45.435715, -122.567821]
];

const stopNames = {
  "7763": "Union Station/NW 6th &amp; Hoyt MAX Stn",
  "7774": "PSU Urban Center/SW 6th &amp; Montgomery MAX Stn",
  "7777": "Pioneer Courthouse/SW 6th Ave MAX Stn",
  "7787": "SW 6th &amp; Pine MAX Station",
  "8340": "Rose Quarter TC MAX Station",
  "8341": "Convention Center MAX Station",
  "8342": "NE 7th Ave MAX Station",
  "8343": "Lloyd Center/NE 11th Ave MAX Station",
  "8344": "Hollywood/NE 42nd Ave MAX Station",
  "8345": "NE 60th Ave MAX Station",
  "8346": "NE 82nd Ave MAX Station",
  "8347": "Gateway/NE 99th Ave TC MAX Station",
  "9299": "NW 6th &amp; Davis MAX Station",
  "10293": "PSU South/SW 6th &amp; College MAX Stn",
  "13123": "SW 6th &amp; Madison MAX Station",
  "13124": "SE Main St MAX Station",
  "13125": "SE Division St MAX Station",
  "13126": "SE Powell Blvd MAX Station",
  "13127": "SE Holgate Blvd MAX Station",
  "13128": "Lents/SE Foster Rd MAX Station",
  "13129": "SE Flavel St MAX Station",
  "13130": "SE Fuller Rd MAX Station",
  "13132": "Clackamas Town Center TC MAX Station"
};

const stops = [
  { stop_id: "8347", name: "Gateway/NE 99th Ave TC MAX Station", lat: 45.530269, lon: -122.563578, times: ["11:43 PM", "12:13 AM", "7:01 AM", "7:43 AM", "8:13 AM", "8:43 AM", "9:04 AM", "9:13 AM"] },
  { stop_id: "13124", name: "SE Main St MAX Station", lat: 45.513986, lon: -122.564467, times: ["11:16 PM", "11:46 PM", "12:16 AM", "7:04 AM", "7:46 AM", "8:16 AM", "8:46 AM", "9:06 AM"] },
  { stop_id: "13125", name: "SE Division St MAX Station", lat: 45.503123, lon: -122.566663, times: ["11:18 PM", "11:48 PM", "12:18 AM", "7:07 AM", "7:48 AM", "8:18 AM", "8:48 AM", "9:08 AM"] },
  { stop_id: "13126", name: "SE Powell Blvd MAX Station", lat: 45.495503, lon: -122.56617, times: ["11:20 PM", "11:50 PM", "12:20 AM", "7:09 AM", "7:50 AM", "8:20 AM", "8:50 AM", "9:10 AM"] },
  { stop_id: "13127", name: "SE Holgate Blvd MAX Station", lat: 45.490868, lon: -122.566315, times: ["11:21 PM", "11:51 PM", "12:21 AM", "7:11 AM", "7:51 AM", "8:21 AM", "8:51 AM", "9:11 AM"] },
  { stop_id: "13128", name: "Lents/SE Foster Rd MAX Station", lat: 45.480188, lon: -122.566871, times: ["11:23 PM", "11:53 PM", "12:23 AM", "7:14 AM", "7:53 AM", "8:23 AM", "8:53 AM", "9:13 AM"] },
  { stop_id: "13129", name: "SE Flavel St MAX Station", lat: 45.467602, lon: -122.566761, times: ["11:25 PM", "11:55 PM", "12:25 AM", "7:17 AM", "7:55 AM", "8:25 AM", "8:55 AM", "9:15 AM"] },
  { stop_id: "13130", name: "SE Fuller Rd MAX Station", lat: 45.453138, lon: -122.573578, times: ["11:28 PM", "11:58 PM", "12:28 AM", "7:21 AM", "7:57 AM", "8:27 AM", "8:57 AM", "9:18 AM"] },
  { stop_id: "13132", name: "Clackamas Town Center TC MAX Station", lat: 45.435721, lon: -122.567769, times: ["11:31 PM", "12:01 AM", "12:31 AM", "7:25 AM", "8:00 AM", "8:30 AM", "9:00 AM", "9:21 AM"] },
  { stop_id: "10293", name: "PSU South/SW 6th &amp; College MAX Stn", lat: 45.509616, lon: -122.683593, times: ["11:42 PM", "12:05 AM", "12:35 AM", "7:11 AM", "7:41 AM", "8:11 AM", "8:41 AM", "9:11 AM"] },
  { stop_id: "7774", name: "PSU Urban Center/SW 6th &amp; Montgomery MAX Stn", lat: 45.511597, lon: -122.68255, times: ["11:43 PM", "12:06 AM", "12:36 AM", "7:12 AM", "7:42 AM", "8:12 AM", "8:42 AM", "9:13 AM"] },
  { stop_id: "13123", name: "SW 6th &amp; Madison MAX Station", lat: 45.515633, lon: -122.680381, times: ["11:45 PM", "12:08 AM", "12:38 AM", "7:15 AM", "7:45 AM", "8:15 AM", "8:45 AM", "9:15 AM"] },
  { stop_id: "7777", name: "Pioneer Courthouse/SW 6th Ave MAX Stn", lat: 45.518964, lon: -122.678558, times: ["11:17 PM", "11:47 PM", "12:10 AM", "12:40 AM", "7:17 AM", "7:47 AM", "8:17 AM", "8:47 AM"] },
  { stop_id: "7787", name: "SW 6th &amp; Pine MAX Station", lat: 45.522323, lon: -122.676756, times: ["11:19 PM", "11:49 PM", "12:12 AM", "12:42 AM", "7:19 AM", "7:49 AM", "8:19 AM", "8:49 AM"] },
  { stop_id: "9299", name: "NW 6th &amp; Davis MAX Station", lat: 45.524405, lon: -122.676429, times: ["11:21 PM", "11:51 PM", "12:14 AM", "12:44 AM", "7:20 AM", "7:50 AM", "8:20 AM", "8:50 AM"] },
  { stop_id: "7763", name: "Union Station/NW 6th &amp; Hoyt MAX Stn", lat: 45.527222, lon: -122.676517, times: ["11:22 PM", "11:52 PM", "12:15 AM", "12:45 AM", "7:22 AM", "7:52 AM", "8:22 AM", "8:52 AM"] },
  { stop_id: "8340", name: "Rose Quarter TC MAX Station", lat: 45.530057, lon: -122.664917, times: ["11:27 PM", "11:57 PM", "12:20 AM", "12:50 AM", "7:27 AM", "7:57 AM", "8:27 AM", "8:57 AM"] },
  { stop_id: "8341", name: "Convention Center MAX Station", lat: 45.530052, lon: -122.661908, times: ["11:29 PM", "11:59 PM", "7:28 AM", "7:58 AM", "8:28 AM", "8:58 AM", "9:28 AM", "9:58 AM"] },
  { stop_id: "8342", name: "NE 7th Ave MAX Station", lat: 45.530055, lon: -122.65774, times: ["11:30 PM", "12:00 AM", "7:30 AM", "8:00 AM", "8:30 AM", "9:00 AM", "9:30 AM", "10:00 AM"] },
  { stop_id: "8343", name: "Lloyd Center/NE 11th Ave MAX Station", lat: 45.530067, lon: -122.653638, times: ["11:32 PM", "12:02 AM", "7:31 AM", "8:01 AM", "8:31 AM", "9:01 AM", "9:31 AM", "10:01 AM"] },
  { stop_id: "8344", name: "Hollywood/NE 42nd Ave MAX Station", lat: 45.532772, lon: -122.620708, times: ["11:35 PM", "12:05 AM", "7:35 AM", "8:05 AM", "8:35 AM", "9:05 AM", "9:35 AM", "10:05 AM"] },
  { stop_id: "8345", name: "NE 60th Ave MAX Station", lat: 45.528764, lon: -122.602703, times: ["11:38 PM", "12:08 AM", "7:37 AM", "8:07 AM", "8:37 AM", "9:07 AM", "9:37 AM", "10:07 AM"] },
  { stop_id: "8346", name: "NE 82nd Ave MAX Station", lat: 45.533221, lon: -122.577794, times: ["11:40 PM", "12:10 AM", "7:40 AM", "8:10 AM", "8:40 AM", "9:10 AM", "9:40 AM", "10:10 AM"] },
]

    const polylineOut = L.polyline(shapeOutbound, { color: 'blue', weight: 4, opacity: 0.7 }).addTo(map);
    map.fitBounds(polylineOut.getBounds());

    const nowPT = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
    const nowMins = nowPT.getHours() * 60 + nowPT.getMinutes();

    stops.forEach(stop => {
      let highlightedTimes = [];
      let foundNext = false;
      stop.times.forEach(timeStr => {
        let cleanTime = timeStr.trim();
        let [h, m] = cleanTime.split(":");
        let schedMins = parseInt(h, 10) * 60 + parseInt(m, 10);
        if (schedMins < nowMins && nowMins - schedMins > 720) {
          schedMins += 1440;
        }
        if (!foundNext && schedMins >= nowMins) {
          highlightedTimes.push(`<span style="background:#4dd0e1; color:#000; padding:2px 6px; border-radius:6px; font-weight:bold;">${cleanTime}</span>`);
          foundNext = true;
        } else {
          highlightedTimes.push(cleanTime);
        }
      });

      L.circleMarker([stop.lat, stop.lon], {
        radius: 6,
        color: '#4dd0e1',
        fillColor: '#4dd0e1',
        fillOpacity: 0.9,
        weight: 1
      })
      .bindPopup(`<strong>${stop.name}</strong><br>${highlightedTimes.join("<br>") || 'No scheduled times'}`)
      .addTo(map);
    });

    let busMarkers = {};
    async function fetchAndDisplay() {
      const res = await fetch(`https://developer.trimet.org/ws/v2/vehicles?route=${routeNumber}&appID=${apiKey}&json=true`);
      const data = await res.json();
      const buses = (data.resultSet.vehicle || []).filter(v => v.routeNumber == routeNumber && v.direction == direction);

      Object.values(busMarkers).forEach(m => map.removeLayer(m));
      busMarkers = {};
      if (!buses.length) return;

      buses.forEach(bus => {
        if (!bus.latitude || !bus.longitude || !bus.blockID) return;
        const icon = L.divIcon({    
           className: '',
           html: `
            <div style="text-align:center;">
              <div style="background:#0071CE;color:#fff;padding:2px 6px;border-radius:6px;font-weight:bold;">${bus.vehicleID}</div>
              <div style="width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:10px solid #00bfff;margin:auto;"></div>
            </div>
          `,
          iconSize: [40, 30], iconAnchor: [20, 30]
        });
        const marker = L.marker([bus.latitude, bus.longitude], { icon }).addTo(map);
        busMarkers[bus.vehicleID] = marker;
      });
    }
    fetchAndDisplay();
    setInterval(fetchAndDisplay, 15000);
  </script>

<footer class="site-footer">
  <a href="terms.html">Terms of Use</a> &nbsp;|&nbsp;
  <a href="contact.html">Contact Us</a> &nbsp;|&nbsp;
  <a href="report.html">Report a Problem</a> &nbsp;|&nbsp;
  <a href="dmca.html">DMCA</a> &nbsp;|&nbsp;
  <a href="privacy.html">Privacy Policy</a>
</footer>

<script>
// ---- Favorite Star Dropdown: Auto-detect route info, menu UI ----

function getRouteInfoFromPage() {
  let routeNumber = "";
  let routeType = "";
  let routeLink = "";

  let titleEl = document.getElementById('route-title');
  if (titleEl) {
    let match = titleEl.textContent.match(/Route\s+(\d+)[^\d]?/i);
    if (match) routeNumber = match[1];
  }
  let typeEl = document.getElementById('route-type');
  if (typeEl) {
    routeType = typeEl.textContent.trim().toLowerCase();
  }
  routeLink = window.location.pathname + window.location.search;

  if (!routeNumber) {
    let titleMatch = document.title.match(/Route\s+(\d+)/i);
    if (titleMatch) routeNumber = titleMatch[1];
  }
  if (!routeType) {
    routeType = document.body.className.includes('rail') ? 'rail' : 
                document.body.className.includes('max') ? 'max' :
                document.body.className.includes('streetcar') ? 'streetcar' :
                'bus';
  }
  if (!routeLink) routeLink = window.location.href;
  if (!routeNumber) return null;
  return {
    number: routeNumber,
    link: routeLink,
    type: routeType
  };
}

function updateStarIcon() {
  const thisRoute = getRouteInfoFromPage();
  if (!thisRoute) return;
  let favorites = JSON.parse(localStorage.getItem('metrofeed_favorites') || '[]');
  const isFavorite = favorites.find(r => r.number === thisRoute.number && r.type === thisRoute.type);
  const btn = document.getElementById('fav-star');
  if (btn) btn.textContent = isFavorite ? "★" : "☆";

  // Update dropdown button label
  const ddBtn = document.getElementById('fav-dropdown-btn');
  if (ddBtn) ddBtn.textContent = isFavorite ? "Remove from Favorites" : "Add to Favorites";
}

// Show/hide dropdown on star click
function showFavDropdown(e) {
  e.stopPropagation();
  const dd = document.getElementById('fav-dropdown');
  dd.style.display = dd.style.display === "block" ? "none" : "block";
  updateStarIcon();

  // When dropdown opens, add outside click listener
  if (dd.style.display === "block") {
    setTimeout(() => {
      document.addEventListener('click', closeFavDropdown);
    }, 10);
  }
}
// Actually add/remove on dropdown click
document.addEventListener("DOMContentLoaded", function() {
  updateStarIcon();
  const ddBtn = document.getElementById('fav-dropdown-btn');
  if (ddBtn) {
    ddBtn.onclick = function(e) {
      e.stopPropagation();
      const thisRoute = getRouteInfoFromPage();
      if (!thisRoute) return;
      let favorites = JSON.parse(localStorage.getItem('metrofeed_favorites') || '[]');
      const exists = favorites.find(r => r.number === thisRoute.number && r.type === thisRoute.type);
      if (exists) {
        favorites = favorites.filter(r => !(r.number === thisRoute.number && r.type === thisRoute.type));
      } else {
        favorites.unshift(thisRoute);
        if (favorites.length > 4) favorites = favorites.slice(0, 4);
      }
      localStorage.setItem('metrofeed_favorites', JSON.stringify(favorites));
      updateStarIcon();
      document.getElementById('fav-dropdown').style.display = "none";
    };
  }
});

// Close dropdown if clicked anywhere else
function closeFavDropdown(e) {
  const dropdown = document.getElementById('fav-dropdown');
  if (!dropdown.contains(e.target)) {
    dropdown.style.display = "none";
    document.removeEventListener('click', closeFavDropdown);
  }
}

</script>
</body>
</html>